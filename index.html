<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TRAME - GUIDE CREDIT &lt; 2 500 000 MGA</title>
<style>
  body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); padding: 20px; }
  h1 { text-align: center; color: #2c3e50; text-shadow: 1px 1px 2px #aaa; }
  form { max-width: 1100px; margin: auto; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  fieldset { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); }
  legend { font-weight: bold; color: #34495e; padding: 5px 10px; background: #ecf0f1; border-radius: 8px; box-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
  label { display: block; margin-top: 10px; font-weight: bold; color: #2c3e50; }
  input, select, textarea { width: 95%; padding: 8px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); transition: all 0.2s ease-in-out; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: #2980b9; box-shadow: 0 0 8px #3498db; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .inline-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  table th, table td { border: 1px solid #bbb; padding: 8px; text-align: center; background: #fdfdfd; }
  table th { background: #ecf0f1; }
  button { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
  button:hover { transform: scale(1.05); }
  .add-btn { background: #27ae60; color: white; }
  .del-btn { background: #e74c3c; color: white; }
  .submit-btn { background: #2980b9; color: white; font-size: 16px; display: inline-block; margin: 20px 10px 0 0; }
  .warning { color: red; font-weight: bold; }
  #total_objet { font-weight: bold; font-size:16px; text-align:left; }
  #total_objet.warning { background: #e74c3c; color: #fff; padding: 2px 5px; border-radius: 5px; }
  #total_objet.normal { background: #2980B9; color: #fff; padding: 2px 5px; border-radius: 5px; }
</style>
</head>
<body>

<div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
  <h1 style="margin: 0;">TRAME - GUIDE CREDIT &lt; 2 500 000 MGA</h1>
  <img src="logo.png" alt="Logo" style="height: 70px;">
</div>

<form>

<!-- INFORMATIONS SUR LA DEMANDE DE CREDIT -->
<fieldset>
  <legend>INFORMATIONS SUR LA DEMANDE DE CREDIT</legend>
  <label>Agence :
    <select required>
      <option value="">-- Sélectionner --</option>
      <option>ANTANANARIVO RP - FLAGSHIP</option>
      <option>ANDOHARANOFOTSY</option>
      <option>ANTSIRABE RP</option>
      <option>VITRINE POSTALE</option>
      <option>SABOTSY NAMEHANA</option>
      <option>FIANARANTSOA RP</option>
      <option>TOAMASINA RP</option>
      <option>MAHAJANGA RP</option>
      <option>TOLIARY RP (TULEAR RP)</option>
      <option>DIEGO RP</option>
      <option>MANAKARA</option>
    </select>
  </label>

  <label>AC traitant : <input type="text" required></label>

  <div class="inline-2">
    <label>Date de visite : <input type="date" id="date_visite" required></label>
    <label>Heure de visite : <input type="time" id="heure_visite" required></label>
  </div>

  <label>Montant de la demande (MGA) : <input type="text" id="montant_demande" readonly></label>
  <label>Durée (mois) : <input type="number" min="0" required></label>
  <label>Capacité de paiement (MGA) : <input type="text" oninput="formatInputMGA(this)" required></label>
  <label>Taux d'intérêt annuel (%) : <input type="number" step="0.01" value="39" readonly></label>
  <label>Date de remboursement demandée : <input type="date" required></label>

  <h3>Objet du crédit</h3>
  <table id="table_objet">
    <thead>
      <tr><th>Libellé</th><th>Montant (MGA)</th><th>Action</th></tr>
    </thead>
    <tbody id="tbody_objet">
      <tr>
        <td><input type="text" name="libelle[]" required></td>
        <td><input type="text" name="montant_objet[]" value="0" oninput="updateTotalDepuisObjet(this)" required></td>
        <td><button type="button" class="del-btn" onclick="supprimerLigne(this)">Supprimer</button></td>
      </tr>
    </tbody>
  </table>
  <button type="button" class="add-btn" onclick="ajouterLigne()">+ Ajouter ligne</button>
  <br><br>
  <label>Total Objet Crédit (MGA) : <input type="text" id="total_objet" readonly class="normal"></label>
  <p id="warning_total" class="warning"></p>
</fieldset>

<!-- INFORMATIONS GENERALES SUR LE DEMANDEUR / CAUTION -->
<fieldset>
  <legend>INFORMATIONS GENERALES SUR LE DEMANDEUR / CAUTION</legend>
  <div class="grid-2">
    <div>
      <h3>Demandeur</h3>
      <label>ID client : <input type="text" id="id_client"></label>
      <label>Rang de crédit :
        <select>
          <option>1er crédit</option>
          <option>2ème crédit</option>
          <option>3ème crédit</option>
          <option>4ème crédit</option>
          <option>5ème crédit</option>
        </select>
      </label>
      <label>Nom et prénoms : <input type="text" id="nom_prenom_client"></label>
      <label>Âge : <input type="number" min="0"></label>
      <label>État civil : <select id="etat_civil_client"><option value="">--Sélectionner--</option><option>Marié(e)</option><option>Veuf(ve)</option><option>Célibataire</option><option>Concubin(e)</option></select></label>
      <label>Nb pers à charge : <input type="number" id="nb_client" min="0"></label>
      <label>Adresse domicile : <textarea id="adresse_domicile_client"></textarea></label>
      <label>Adresse activité : <textarea id="adresse_activite_client"></textarea></label>
    </div>
    <div>
      <h3>Caution</h3>
      <label>ID caution : <input type="text" id="id_caution"></label>
      <label>Lien avec le demandeur : 
        <select id="lien_demandeur">
          <option value="">--Sélectionner--</option>
          <option>Epoux(se)</option>
          <option>Concubin(e)</option>
          <option>Fratrie</option>
          <option>Ami/Collègue</option>
        </select>
      </label>
      <label>Nom et prénoms : <input type="text" id="nom_prenom_caution"></label>
      <label>Âge : <input type="number" min="0"></label>
      <label>État civil : <select id="etat_civil_caution"><option value="">--Sélectionner--</option><option>Marié(e)</option><option>Veuf(ve)</option><option>Célibataire</option><option>Concubin(e)</option></select></label>
      <label>Nb pers à charge : <input type="number" id="nb_caution" min="0"></label>
      <label>Adresse domicile : <textarea id="adresse_domicile_caution"></textarea></label>
    </div>
  </div>
</fieldset>

<!-- HISTORIQUE DE L'ACTIVITE ET ENGAGEMENT -->
<fieldset>
  <legend>HISTORIQUE DE L'ACTIVITE ET ENGAGEMENT</legend>
  <table id="table_activite">
    <thead>
      <tr>
        <th>Nom de l'activité</th>
        <th>Marge</th>
        <th>Ancienneté (années)</th>
        <th>Secteur</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody_activite">
      <!-- Vide au chargement -->
    </tbody>
  </table>
  <button type="button" class="add-btn" onclick="ajouterActivite()">+ Ajouter activité</button>
</fieldset>

<fieldset>
  <legend id="legend_activite">FONCTIONNEMENT DE L'ACTIVITE</legend>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    
    <!-- Colonne de gauche -->
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <label>Nom de l'activité (1ère ligne) :
        <input type="text" id="nom_activite_premiere_ligne" readonly>
      </label>

      <label>Marge de l'activité (1ère ligne) :
        <input type="text" id="marge_activite_premiere_ligne" readonly>
      </label>

      <label style="color: blue; font-weight: bold; text-decoration: underline;">
        1-Chiffre d'affaires mensuel :
      </label>

      <label>Fréquence de vente (par mois) :
        <input type="number" id="frequence_vente" min="0" placeholder="0">
      </label>

      <label>Vente selon derniers jours :</label>
      <div style="display: flex; gap: 10px; margin-top: 5px;">
        <input type="text" id="vente_jour_v3" placeholder="V-3" oninput="majVenteMensuelle()">
        <input type="text" id="vente_jour_v2" placeholder="V-2" oninput="majVenteMensuelle()">
        <input type="text" id="vente_jour_v1" placeholder="V-1" oninput="majVenteMensuelle()">
        <input type="text" id="vente_mensuelle" placeholder="Vente mensuelle" readonly 
               style="background:#fff9c4;font-weight:bold;color:darkblue;">
      </div>

      <label>Vente selon registre :</label>
      <div style="display: flex; gap: 10px; margin-top: 5px;">
        <input type="text" id="vente_registre_m3" placeholder="M-3" oninput="majVenteMensRV()">
        <input type="text" id="vente_registre_m2" placeholder="M-2" oninput="majVenteMensRV()">
        <input type="text" id="vente_registre_m1" placeholder="M-1" oninput="majVenteMensRV()">
        <input type="text" id="vente_registre_mensuelle" placeholder="Vente mens RV" readonly 
               style="background:#fff9c4;font-weight:bold;color:darkgreen;">
      </div>

      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="ca_ligne1" style="width: 150px;">CA (ligne 1) :</label>
        <input type="text" id="ca_ligne1" name="ca_ligne1" readonly
               style="flex: 1; padding: 8px; background-color: #1E90FF; color: white; font-weight: bold; border: none; border-radius: 5px;">
      </div>

      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="creances_actuelles" style="width: 150px;">Créances actuelles</label>
        <input type="text" id="creances_actuelles" name="creances_actuelles" 
               style="flex: 1; padding: 8px; background-color: #FFC0CB; color: black; font-weight: bold; border: none; border-radius: 5px;">
      </div>

      <label style="color: blue; font-weight: bold; text-decoration: underline;">
        2-CAMV mensuel :
      </label>
    </div>
      
    <!-- Colonne de droite -->
    <div style="display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 10px;">
      <label style="font-weight:bold; color: darkred;">Croisements</label>
      <textarea id="croisements" placeholder="Saisissez ici vos croisements"
        style="padding: 12px 8px; height: 190px; width: 100%; background-color: #E0FFFF; border: none; border-radius: 5px; font-weight: normal; box-sizing: border-box; resize: none;"></textarea>

      <label style="font-weight:bold; color: darkred;">Notes</label>
      <textarea id="notes" placeholder="Insérez ici vos notes et remarques"
        style="padding: 12px 8px; height: 190px; width: 100%; background-color: #E0FFFF; border: none; border-radius: 5px; font-weight: normal; box-sizing: border-box; resize: none;"></textarea>
    </div>



    <label>Fréquence d'achat (par mois) :
      <input type="number" id="frequence_achat" min="0" placeholder="0">
    </label>
  </div>

  <label>Achat max/min/CAMV Mensuel:</label>
  <div style="display: flex; gap: 10px; margin-top: 5px; width: 45%;">
    <input type="text" id="achat_max" placeholder="max" oninput="majCAMVMensuel()">
    <input type="text" id="achat_min" placeholder="min" oninput="majCAMVMensuel()">
    <input type="text" id="camv_mensuel" placeholder="CAMV Mensuel" readonly 
           style="background:#fff9c4;font-weight:bold;color:darkblue;">
  </div>

  <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
    <label for="camv_selon_marge" style="width: 150px; font-weight: bold;">CAMV selon marge</label>
    <input type="text" id="camv_selon_marge" name="camv_selon_marge" readonly
           style="width: 30%; padding: 8px; background-color: #1E90FF; color: white; font-weight: bold; border: none; border-radius: 5px;">
  </div>

  <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
    <label for="camv_final" style="width: 150px; font-weight: bold;">CAMV final</label>
    <input type="text" id="camv_final" name="camv_final" readonly
           style="width: 30%; padding: 8px; background-color: #1E90FF; color: white; font-weight: bold; border: none; border-radius: 5px;">
  </div>

  <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
    <label for="dettes_fournisseurs" style="width: 150px;">Dettes fournisseurs</label>
    <input type="text" id="dettes_fournisseurs" name="dettes_fournisseurs" 
           style="width: 30%; padding: 8px; background-color: #FFC0CB; color: black; font-weight: bold; border: none; border-radius: 5px;">
  </div>
</fieldset>

</form>

<script>
/*************************************************
 *  DONNÉES & CONSTANTES
 *************************************************/
const ACTIVITES_MARGES = {
  "Epicerie": "16%", "Epi-bar": "23%", "Boulangerie": "5%", "Pâtisserie": "25%", "Menuiserie": "30%",
  "Murisserie de banane": "8%", "Confection": "25%", "Collecteurs produits riz": "7%", "Collecteurs produits locaux": "20%",
  "Poissonnerie": "15%", "Commerce Provende animale": "18%", "Vente cosmétiques": "20%", "Quincailleries": "18%",
  "Pharmacie": "12%", "Vente de pneus": "14%", "Taxiphone = vente de carte": "5%", "Vente d'articles divers": "15%",
  "Vente de fourniture scolaire": "18%", "Multiservices": "-100%", "Pièces pour véhicules, accessoires": "23%",
  "Pièces pour moto, accessoires": "15%", "Pièces pour bicyclette, accessoires": "15%", "Fruits et légumes": "15%",
  "Boucherie : viande bovine, porcine et volaille de chair, charcuterie": "18%", "Production yaourt": "35%",
  "Vente Vêtement: produits neufs": "23%", "Vente chaussures: produits neufs": "30%", "Vêtement chaussures: produits usés": "25%",
  "Vêtement textiles: produits usés": "18%", "Grossiste PPN": "5%", "Bijouterie": "23%", "Lapidaire": "35%",
  "Vente produit en plastique": "13%", "Vente produit laitier": "10%", "Vente d'œuf": "10%", "Kafé sy mofo": "60%",
  "Grillade/Snack": "50%", "Location maison": "0%", "Gargote": "50%", "Restaurant": "60%", "Poulets de chair": "20%",
  "Poules pondeuses": "21%", "Vente de riz blanc en gros": "15%", "Vente de riz blanc au détail": "30%",
  "Vente de poissons secs en gros": "23%", "Vente de poissons secs au détail": "28%", "Vente de produits locaux en gros": "18%",
  "Vente de produits locaux au détail": "40%", "Cordonnier et réparateur de chaussures": "-100%", "Coiffure et esthétique": "-100%",
  "Vulca – Service de Réparation de Pneus": "-100%", "Cybercafé": "-100%", "Dépôt de médicament": "-100%",
  "Cliniques de soins de base": "-100%", "Ecole": "-100%", "Location voiture": "-100%", "Tranport des personnes": "-100%",
  "Transport des marchandises": "-100%", "Taxi-ville": "-100%", "Taxi-moto": "-100%", "Autres services": "-100%",
  "Cyclo-pousse": "-100%", "Pousse-pousse": "-100%", "Tuc-tuc": "-100%"
};

/*************************************************
 *  UTILITAIRES
 *************************************************/
function fmt0(n){ return (n||0).toLocaleString('fr-FR', {maximumFractionDigits:0}); }

function formatInputMGA(input){
  if(!input) return;
  let val = parseFloat(String(input.value || "").replace(/\s|MGA/g,'')); 
  if (isNaN(val)) { input.value = ""; return; }
  input.value = fmt0(val);
}

// Suffixe MGA avec séparateurs, gestion focus/blur pour édition facile
function attachMGAFormatter(inputId){
  const el = document.getElementById(inputId);
  if(!el) return;
  el.addEventListener('input', function(){
    let v = this.value.replace(/\D/g,''); // chiffres uniquement
    if(!v){ this.value=''; return; }
    this.value = fmt0(parseInt(v,10)) + ' MGA';
  });
  el.addEventListener('focus', function(){
    this.value = this.value.replace(/\s?MGA$/,'');
  });
  el.addEventListener('blur', function(){
    const digits = this.value.replace(/\D/g,'');
    this.value = digits ? fmt0(parseInt(digits,10)) + ' MGA' : '';
  });
}

function remplirSelectActivite(select){
  if(!select) return;
  select.innerHTML = '<option value="">--Sélectionner--</option>';
  Object.keys(ACTIVITES_MARGES).forEach(nom => {
    const opt = document.createElement('option');
    opt.value = nom; opt.textContent = nom; select.appendChild(opt);
  });
}

/*************************************************
 *  OBJET DU CRÉDIT
 *************************************************/
function ajouterLigne(){
  const tbody = document.getElementById('tbody_objet');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" name="libelle[]" required></td>
    <td><input type="text" name="montant_objet[]" value="0" oninput="updateTotalDepuisObjet(this)" required></td>
    <td><button type="button" class="del-btn" onclick="supprimerLigne(this)">Supprimer</button></td>`;
  tbody.appendChild(tr);
}

function supprimerLigne(btn){
  btn.closest('tr')?.remove();
  updateTotalDepuisObjet();
}

function updateTotalDepuisObjet(input){
  if(input) formatInputMGA(input);
  let total = 0;
  document.querySelectorAll('input[name="montant_objet[]"]').forEach(i=>{
    total += parseFloat(String(i.value||"").replace(/\s/g,'')) || 0;
  });
  const totalInput = document.getElementById('total_objet');
  totalInput.value = fmt0(total);
  totalInput.className = total>2575000?"warning":"normal";
  document.getElementById('montant_demande').value = totalInput.value;
  document.getElementById('warning_total').innerText = total>2575000?"⚠ Le total dépasse 2 575 000 MGA !": "";
}

function verifierMontant(){
  const total = parseFloat(String(document.getElementById('total_objet').value||"").replace(/\s/g,'')) || 0;
  if(total>2575000){ alert("Le total de l'objet de crédit ne peut pas dépasser 2 575 000 MGA !"); return false; }
  return true;
}

/*************************************************
 *  ACTIVITÉS
 *************************************************/
function ajouterActivite(){
  const tbody = document.getElementById('tbody_activite');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><select name="nom_activite[]" required></select></td>
    <td><input type="text" name="marge_activite[]" readonly></td>
    <td><input type="number" name="anciennete_activite[]" min="0" required></td>
    <td><select name="secteur_activite[]" required>
        <option value="">--Sélectionner--</option>
        <option>Commerce</option>
        <option>Élevage</option>
        <option>Production</option>
        <option>Salarié</option>
        <option>Transport</option>
        <option>Services</option>
      </select></td>
    <td><button type="button" class="del-btn" onclick="supprimerActivite(this)">Supprimer</button></td>`;
  tbody.appendChild(tr);

  const selectActivite = tr.querySelector('select[name="nom_activite[]"]');
  const inputMarge = tr.querySelector('input[name="marge_activite[]"]');
  remplirSelectActivite(selectActivite);

  selectActivite.addEventListener('change', function(){
    inputMarge.value = ACTIVITES_MARGES[this.value] || "0%";
    majNomActivitePremiereLigne();
    majMargeActivitePremiereLigne();
    majLegendActivite();
    majCAMVSelonMarge();
  });
}

function supprimerActivite(btn){ 
  btn.closest('tr')?.remove(); 
  majNomActivitePremiereLigne(); 
  majMargeActivitePremiereLigne();
  majLegendActivite();
  majCAMVSelonMarge();
}

function majNomActivitePremiereLigne(){
  const premiereActivite = document.querySelector('#tbody_activite tr select[name="nom_activite[]"]');
  document.getElementById('nom_activite_premiere_ligne').value = premiereActivite ? (premiereActivite.value||'') : '';
}

function majMargeActivitePremiereLigne() {
  const premiereActiviteMarge = document.querySelector('#tbody_activite tr:first-child input[name="marge_activite[]"]');
  document.getElementById('marge_activite_premiere_ligne').value = premiereActiviteMarge ? premiereActiviteMarge.value : '';
}

function majLegendActivite(){
  const legend = document.getElementById('legend_activite');
  const nom = document.getElementById('nom_activite_premiere_ligne').value;
  legend.textContent = nom ? "FONCTIONNEMENT DE L'ACTIVITE " + nom : "FONCTIONNEMENT DE L'ACTIVITE";
}

/*************************************************
 *  SYNCHRO DEMANDEUR / CAUTION
 *************************************************/
function synchroniserCaution(){
  const lien = document.getElementById('lien_demandeur').value;
  if(lien === "Epoux(se)" || lien === "Concubin(e)"){
    document.getElementById('etat_civil_caution').value = document.getElementById('etat_civil_client').value;
    document.getElementById('nb_caution').value = document.getElementById('nb_client').value;
    document.getElementById('adresse_domicile_caution').value = document.getElementById('adresse_domicile_client').value;
  }
}

/*************************************************
 *  VENTES & CA (ligne 1)
 *************************************************/
function majVenteMensuelle(){
  ['vente_jour_v3','vente_jour_v2','vente_jour_v1'].forEach(id=>formatInputMGA(document.getElementById(id)));
  const v3 = parseFloat((document.getElementById('vente_jour_v3').value||'').replace(/\s/g,''))||0;
  const v2 = parseFloat((document.getElementById('vente_jour_v2').value||'').replace(/\s/g,''))||0;
  const v1 = parseFloat((document.getElementById('vente_jour_v1').value||'').replace(/\s/g,''))||0;
  const freq = parseFloat(document.getElementById('frequence_vente').value)||0;
  const moyenne = (v3 + v2 + v1) / 3;
  const resultat = Math.round(moyenne * freq);
  document.getElementById('vente_mensuelle').value = resultat>0 ? fmt0(resultat)+" MGA" : "";
  majCALigne1();
  majCAMVSelonMarge();
}

function majVenteMensRV(){
  ['vente_registre_m3','vente_registre_m2','vente_registre_m1'].forEach(id=>formatInputMGA(document.getElementById(id)));
  const m3 = parseFloat((document.getElementById('vente_registre_m3').value||'').replace(/\s/g,''))||0;
  const m2 = parseFloat((document.getElementById('vente_registre_m2').value||'').replace(/\s/g,''))||0;
  const m1 = parseFloat((document.getElementById('vente_registre_m1').value||'').replace(/\s/g,''))||0;
  const moyenne = Math.round((m3 + m2 + m1) / 3);
  document.getElementById('vente_registre_mensuelle').value = moyenne>0 ? fmt0(moyenne)+" MGA" : "";
  majCALigne1();
  majCAMVSelonMarge();
}

function majCALigne1(){
  const venteMensRV = parseFloat((document.getElementById('vente_registre_mensuelle').value||'').replace(/\s|MGA/g,''))||0;
  const venteMensuelle = parseFloat((document.getElementById('vente_mensuelle').value||'').replace(/\s|MGA/g,''))||0;
  const ca = (venteMensRV === 0) ? venteMensuelle : venteMensRV;
  document.getElementById('ca_ligne1').value = ca>0 ? fmt0(ca)+" MGA" : "";
}

/*************************************************
 *  CAMV (mensuel / selon marge / final)
 *************************************************/
function majCAMVMensuel(){
  ['achat_max','achat_min'].forEach(id=>formatInputMGA(document.getElementById(id)));
  const max = parseFloat((document.getElementById('achat_max').value||'').replace(/\s|MGA/g,''))||0;
  const min = parseFloat((document.getElementById('achat_min').value||'').replace(/\s|MGA/g,''))||0;
  const freq = parseFloat(document.getElementById('frequence_achat').value)||0;
  const moyenne = (max + min) / 2;
  const resultat = Math.round(moyenne * freq);
  document.getElementById('camv_mensuel').value = resultat>0 ? fmt0(resultat)+" MGA" : "0 MGA";
  majCALigne1();
  majCAMVFinal();
}

function majCAMVSelonMarge(){
  // CA ligne 1
  let caStr = document.getElementById('ca_ligne1').value || "0";
  let ca = parseFloat(caStr.replace(/\s|MGA/g,'')) || 0;

  // Marge 1ère activité
  let margeStr = document.getElementById('marge_activite_premiere_ligne').value || "0%";
  let marge = parseFloat(margeStr.replace('%',''))/100;
  if(isNaN(marge)) marge = 0;

  let camv = 0;
  // Sécurité : si marge <= 0 (0% ou codes -100%), CAMV = 0
  if(marge <= 0){
    camv = 0;
  } else {
    camv = Math.round(ca / (1 + marge));
  }

  document.getElementById('camv_selon_marge').value = camv > 0 ? fmt0(camv) + " MGA" : "0 MGA";
  majCAMVFinal();
}

function majCAMVFinal(){
  const camvMensuel = parseFloat((document.getElementById('camv_mensuel').value||'').replace(/\s|MGA/g,''))||0;
  const camvMarge   = parseFloat((document.getElementById('camv_selon_marge').value||'').replace(/\s|MGA/g,''))||0;
  const camvFinal = Math.max(camvMensuel, camvMarge);
  document.getElementById('camv_final').value = camvFinal>0 ? fmt0(camvFinal)+" MGA" : "0 MGA";
}

/*************************************************
 *  SAUVEGARDE (exemple)
 *************************************************/
function sauvegarder(){
  const donneesActivites = [];
  document.querySelectorAll('#tbody_activite tr').forEach(tr=>{
    donneesActivites.push({
      activite: tr.querySelector('select[name="nom_activite[]"]').value,
      marge: tr.querySelector('input[name="marge_activite[]"]').value,
      anciennete: tr.querySelector('input[name="anciennete_activite[]"]').value,
      secteur: tr.querySelector('select[name="secteur_activite[]"]').value
    });
  });
  console.log('Activités enregistrées :', donneesActivites);
  alert('Données sauvegardées avec succès !');
}

function sauvegarderHTML(){
  if(!verifierMontant()) return;
  const nomPrenom = document.querySelector('#nom_prenom_client').value || 'Demandeur';
  const date = new Date();
  const pad = n=>('0'+n).slice(-2);
  const dateStr = `${date.getFullYear()}${pad(date.getMonth()+1)}${pad(date.getDate())}${pad(date.getHours())}${pad(date.getMinutes())}`;

  const cloneBody = document.body.cloneNode(true);
  cloneBody.querySelectorAll('input, textarea, select').forEach(el=>{
    if(el.tagName === 'TEXTAREA') el.innerHTML = el.value;
    else if(el.tagName === 'SELECT'){
      el.querySelectorAll('option').forEach(opt=>{
        if(opt.value === el.value) opt.setAttribute('selected','selected'); else opt.removeAttribute('selected');
      });
    } else el.setAttribute('value', el.value);
  });
  cloneBody.querySelectorAll('button').forEach(btn=> btn.style.display = 'none');

  const htmlContent = `<!DOCTYPE html>\n<html lang='fr'>\n${document.head.outerHTML}\n<body>\n${cloneBody.innerHTML}\n</body>\n</html>`;
  const blob = new Blob([htmlContent], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `TRAME_${nomPrenom}_${dateStr}.html`;
  a.click();
}

/*************************************************
 *  ÉCOUTEURS & INIT
 *************************************************/
document.addEventListener('DOMContentLoaded', ()=>{
  // Champs avec unité MGA
  attachMGAFormatter('creances_actuelles');
  attachMGAFormatter('dettes_fournisseurs');

  // Initialiser une éventuelle ligne d'activité existante (si pré-rendue)
  document.querySelectorAll('#tbody_activite tr').forEach(tr=>{
    const select = tr.querySelector('select[name="nom_activite[]"]');
    const inputMarge = tr.querySelector('input[name="marge_activite[]"]');
    if(select && inputMarge){
      remplirSelectActivite(select);
      if(select.value){ inputMarge.value = ACTIVITES_MARGES[select.value] || '0%'; }
      select.addEventListener('change', function(){
        inputMarge.value = ACTIVITES_MARGES[this.value] || '0%';
        majNomActivitePremiereLigne();
        majMargeActivitePremiereLigne();
        majLegendActivite();
        majCAMVSelonMarge();
      });
    }
  });

  // Nom activité (1ère ligne) & legend
  majNomActivitePremiereLigne();
  majMargeActivitePremiereLigne();
  majLegendActivite();

  // Écoute générale sur le tbody activités
  const tbody = document.getElementById('tbody_activite');
  tbody.addEventListener('change', e=>{
    if(e.target && e.target.name === 'nom_activite[]'){
      majNomActivitePremiereLigne();
      majMargeActivitePremiereLigne();
      majLegendActivite();
      majCAMVSelonMarge();
    }
  });

  // Synchro caution
  document.getElementById('lien_demandeur').addEventListener('change', synchroniserCaution);
  document.getElementById('etat_civil_client').addEventListener('input', synchroniserCaution);
  document.getElementById('nb_client').addEventListener('input', synchroniserCaution);
  document.getElementById('adresse_domicile_client').addEventListener('input', synchroniserCaution);

  // Ventes -> listeners complémentaires
  ['vente_jour_v3','vente_jour_v2','vente_jour_v1','frequence_vente'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.addEventListener('input', ()=>{ majVenteMensuelle(); });
  });
  ['vente_registre_m3','vente_registre_m2','vente_registre_m1'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.addEventListener('input', ()=>{ majVenteMensRV(); });
  });

  // CAMV: recalculer selon marge quand CA change
  ['vente_mensuelle','vente_registre_mensuelle','ca_ligne1'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.addEventListener('input', majCAMVSelonMarge);
  });

  // CAMV mensuel dépend de fréquence d'achat
  const freqAchat = document.getElementById('frequence_achat');
  if(freqAchat) freqAchat.addEventListener('input', majCAMVMensuel);

  // Objet crédit -> total initial
  updateTotalDepuisObjet();
});
</script>
</body>
</html>

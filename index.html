<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRAME - GUIDE CREDIT < 2 500 000 MGA</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); padding: 20px; margin: 0; }
  h1 { text-align: center; color: #2c3e50; text-shadow: 1px 1px 2px #aaa; margin: 0; }
  form { max-width: 3000px; margin: auto; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  fieldset { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); }
  legend { font-weight: bold; color: #34495e; padding: 5px 10px; background: #ecf0f1; border-radius: 8px; box-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
  label { display: block; margin-top: 10px; font-weight: bold; color: #2c3e50; }
  input, select, textarea { width: 95%; padding: 8px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); transition: all 0.2s ease-in-out; box-sizing: border-box; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: #2980b9; box-shadow: 0 0 8px #3498db; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .inline-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end; }
  .flex-row { display: flex; gap: 10px; width: 100%; }
  .flex-row input { flex: 1; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  table th, table td { border: 1px solid #bbb; padding: 8px; text-align: center; background: #fdfdfd; }
  table th { background: #ecf0f1; }
  button { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
  button:hover { transform: scale(1.05); }
  .add-btn { background: #27ae60; color: white; }
  .del-btn { background: #e74c3c; color: white; }
  .submit-btn { background: #2980b9; color: white; font-size: 16px; display: inline-block; margin: 20px 10px 0 0; }
  .warning { color: red; font-weight: bold; }
  #total_objet { font-weight: bold; font-size:16px; text-align:left; }
  #total_objet.warning { background: #e74c3c; color: #fff; padding: 2px 5px; border-radius: 5px; }
  #total_objet.normal { background: #2980B9; color: #fff; padding: 2px 5px; border-radius: 5px; }
  .opex-wrapper { display: flex; justify-content: flex-end; margin-top: 10px; }
  .opex-table { width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; }
  .opex-table th, .opex-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  .opex-table input { width: 100%; padding: 4px; box-sizing: border-box; text-align: left; font-weight: bold; }
  .opex-total td { background-color: #444; color: white; font-weight: bold; padding: 5px; }
  .df-wrapper { display: flex; justify-content: flex-end; margin-top: 10px; }
  .df-table { width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; }
  .df-table th, .df-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  .df-table input { width: 100%; padding: 4px; box-sizing: border-box; text-align: left; font-weight: bold; }
  .df-total td { background-color: #444; color: white; font-weight: bold; padding: 5px; }
  #tableMMP tfoot td { font-weight: bold; }
  #tableMMP tfoot tr.total-row td { background-color: #696969; color: #fff; }
  #tableMMP tfoot tr.mmp-row td { background-color: #f39c12; color: #fff; }
  .activite-tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #3498db; }
  .activite-tab { padding: 10px 20px; background: #ecf0f1; border: 1px solid #ddd; border-bottom: none; border-radius: 5px 5px 0 0; cursor: pointer; margin-right: 5px; font-weight: bold; }
  .activite-tab.active { background: #3498db; color: white; }
  .activite-content { display: none; }
  .activite-content.active { display: block; }
  input.result { background:#e3f2fd; font-weight:bold; text-align:right; border:none; width: 100%; padding: 3px; }
  .toggle-btn { cursor: pointer; border: none; background: none; font-size: 14px; margin-left: 10px; color: #007BFF; }
  .hidden { display: none; }
  input.sep{ text-align:right; width:100%; box-sizing:border-box; }
  .readonly-input { font-weight: bold; color: white; background-color: #87CEEB; border: 1px solid #87CEEB; padding: 5px; border-radius: 4px; }
  .numeric { text-align: right; padding-right: 4px; }
  .resultat-final { width: 30%; font-weight: bold; color: #fff; background-color: #696969; text-align: right; padding: 4px 6px; border: none; border-radius: 4px; }
  .resultat-bilan { font-weight: bold; color: #fff; background-color: #696969; text-align: right; padding: 4px 6px; border: none; border-radius: 4px; }
  .section-title { font-weight: bold; color: #0066cc; text-decoration: underline; font-size: 14px; margin-bottom: 6px; }
  #hist_activite_content { overflow: hidden; max-height: 2000px; transition: max-height 0.28s ease, opacity 0.22s ease; opacity: 1; }
  #hist_activite_content.collapsed { max-height: 0; opacity: 0; }
  #activite-wrapper { overflow: hidden; max-height: 2000px; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 1; }
  #activite-wrapper.collapsed { max-height: 0; opacity: 0; }
  .blue-box { background-color: #87CEEB; color: white; font-weight: bold; border: 1px solid #87CEEB; padding: 4px 6px; border-radius: 4px; text-align: right; }
  .notes-box { width: 100%; min-height: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: Arial, sans-serif; font-size: 12px; }
  #table_cout { font-size: 12px; }
  #table_cout input { font-size: 12px; padding: 2px 4px; }
  #table_cout th, #table_cout td { padding: 4px; }
  #table_garanties { width: auto; table-layout: auto; }
  #table_garanties td, #table_garanties th { white-space: nowrap; word-break: break-word; }
  .bold-row { font-weight: bold; }
  .red-text { color: #d9534f; }
  #table_cashflow td, #table_cashflow th { padding: 5px; }
  #table_cout th, #table_cout td { text-align: center; vertical-align: middle; }
  #table_cout input { text-align: center; width: 100%; box-sizing: border-box; }
  .mini-legend { display: inline-block; font-weight: bold; padding: 2px 6px; border: 1px solid #ccc; border-radius: 4px; background-color: #f9f9f9; margin-bottom: 4px; font-size: 0.85em; }
  .readonly-blue { background-color: #b3d9ff; border: 1px solid #7fbfff; color: #000; }
  .ratio-red { background-color: #ff0000 !important; color: white !important; }
  .ratio-green { background-color: #87CEEB !important; color: white !important; }
  .error { border: 2px solid red !important; }
</style>
</head>
<body>

<div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
  <h1>TRAME - GUIDE CREDIT < 2 500 000 MGA</h1>
</div>

<form id="mainForm">
<fieldset>
  <legend><i class="fas fa-info-circle"></i> INFORMATIONS SUR LA DEMANDE DE CREDIT</legend>
  <div class="inline-2">
  <label>Agence :
    <select required>
      <option value="">-- Sélectionner --</option>
      <option>ANTANANARIVO RP - FLAGSHIP</option>
      <option>ANDOHARANOFOTSY</option>
      <option>ANTSIRABE RP</option>
      <option>VITRINE POSTALE</option>
      <option>SABOTSY NAMEHANA</option>
      <option>FIANARANTSOA RP</option>
      <option>TOAMASINA RP</option>
      <option>MAHAJANGA RP</option>
      <option>TOLIARY RP (TULEAR RP)</option>
      <option>DIEGO RP</option>
      <option>MANAKARA</option>
    </select>
  </label>
  <label>AC traitant : <input type="text" required></label>
  </div>
  <div class="inline-2">
    <label>Date de visite : <input type="date" id="date_visite" required></label>
    <label>Heure de visite : <input type="time" id="heure_visite" required></label>
  </div>
<div class="inline-2">
  <label>Montant de la demande (MGA) : <input type="text" id="montant_demande" readonly style="font-weight:bold; color:white; background-color:orange;"></label>
  <label>Durée (mois) : <input type="number" min="0" required></label>
  </div>
  <div class="inline-2">
  <label>Capacité de paiement (MGA) : <input type="text" id="capacite_paiement" required></label>
  <label>Taux d'intérêt annuel (%) : <input type="number" step="0.01" value="39" readonly></label>
  </div>
  <label>Date de remboursement demandée : <input type="date" required></label>
  <h3>Objet du crédit</h3>
  <table id="table_objet">
    <thead><tr><th>Libellé</th><th>Montant (MGA)</th><th>Action</th></tr></thead>
    <tbody id="tbody_objet">
      <tr>
        <td><input type="text" name="libelle[]" required></td>
        <td><input type="text" name="montant_objet[]" value="0" oninput="updateTotalDepuisObjet(this)" onblur="formatMontantObjet(this)" /></td>
        <td><button type="button" class="del-btn" onclick="supprimerLigne(this)">Supprimer</button></td>
      </tr>
    </tbody>
  </table>
  <button type="button" class="add-btn" onclick="ajouterLigne()">Ajouter ligne</button>
  <br><br>
  <label>Total Objet Crédit (MGA) : <input type="text" id="total_objet" readonly class="normal"></label>
  <p id="warning_total" class="warning"></p>
</fieldset>

<fieldset>
  <legend id="legend_infos_generales"><i class="fas fa-users"></i> INFORMATIONS GENERALES SUR LE DEMANDEUR / CAUTION
    <button type="button" class="toggle-btn" onclick="toggleGeneralInfo()"><i class="fas fa-eye-slash"></i> Masquer</button>
  </legend>
  <div id="infos_generales_content">
    <div class="grid-2">
      <div>
        <h3>Demandeur</h3>
        <label>ID client : <input type="text" id="id_client"></label>
        <label>Rang de crédit :<select><option>1er crédit</option><option>2ème crédit</option><option>3ème crédit</option><option>4ème crédit</option><option>5ème crédit</option></select></label>
        <label>Nom et prénoms : <input type="text" id="nom_prenom_client"></label>
        <label>Âge : <input type="number" min="0"></label>
        <label>État civil : <select id="etat_civil_client"><option value="">--Sélectionner--</option><option>Marié(e)</option><option>Veuf(ve)</option><option>Célibataire</option><option>Concubin(e)</option><option>Divorcé(e)</option></select></label>
        <label>Nb pers à charge : <input type="number" id="nb_client" min="0"></label>
		<label>N°téléphone : <input type="text" id="num_client" placeholder="xxx xx xxx xx"></label>
        <label>Adresse domicile : <textarea id="adresse_domicile_client" placeholder="Adresse domicile (condition de logt)"></textarea></label>
        <label>Adresse activité : <textarea id="adresse_activite_client" placeholder="Adresse activité (condition de logt)"></textarea></label>
      </div>
      <div>
        <h3>Caution</h3>
        <label>ID caution : <input type="text" id="id_caution"></label>
        <label>Lien avec le demandeur : <select id="lien_demandeur"><option value="">--Sélectionner--</option><option>Epoux(se)</option><option>Concubin(e)</option><option>Fratrie</option><option>Ami/Collègue</option><option>Parent</option></select></label>
        <label>Nom et prénoms : <input type="text" id="nom_prenom_caution"></label>
        <label>Âge : <input type="number" min="0"></label>
        <label>État civil : <select id="etat_civil_caution"><option value="">--Sélectionner--</option><option>Marié(e)</option><option>Veuf(ve)</option><option>Célibataire</option><option>Concubin(e)</option><option>Divorcé(e)</option></select></label>
        <label>Nb pers à charge : <input type="number" id="nb_caution" min="0"></label>
		<label>N°téléphone : <input type="text" id="num_caution" placeholder="xxx xx xxx xx"></label>
        <label>Adresse domicile : <textarea id="adresse_domicile_caution" placeholder="Adresse domicile (condition de logt)"></textarea></label>
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
          <label for="revenus_mensuels_caution" style="width: 150px;">Revenus mensuels</label>
          <input type="text" id="revenus_mensuels_caution" name="revenus_mensuels_caution" placeholder="0 MGA">
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
          <label for="source_revenus" style="width: 150px;">Source</label>
          <input type="text" id="source_revenus" name="source_revenus" placeholder="Ex : Salaire, location, commerce...">
        </div>
      </div>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend id="legend_hist_activite"><i class="fas fa-history"></i> HISTORIQUE DE L'ACTIVITE ET ENGAGEMENT
    <button type="button" id="btn_toggle_activite" onclick="toggleActiviteHistory()"><i class="fas fa-eye-slash"></i> Masquer</button>
  </legend>
  <div id="hist_activite_content">
    <table id="table_activite">
      <thead><tr><th>Nom de l'activité</th><th>Marge</th><th>Ancienneté (années)</th><th>Secteur</th><th>Action</th></tr></thead>
      <tbody id="tbody_activite"></tbody>
    </table>
    <button type="button" class="add-btn" onclick="ajouterActivite()">Ajouter activité</button>
    <div id="sections_activite"></div>
    <fieldset style="margin-top:15px;">
      <legend><i class="fas fa-money-check"></i> INFORMATIONS SALARIALES & FINANCIÈRES</legend>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <label>Nom de la société<input type="text" name="societe" placeholder="Ex : PAOMA, TELMA, STAR..."></label>
        <label>Poste<input type="text" name="poste" placeholder="Ex : Comptable"></label>
        <label>Salaire<input type="text" name="Salaire" placeholder="0 MGA" id="Salaire" onblur="formatFinancialField(this)"></label>
        <label>Solde mobile money<input type="text" name="solde_mobile" placeholder="0 MGA" id="solde_mobile" onblur="formatFinancialField(this)"></label>
        <label>Solde épargne / banque<input type="text" name="solde_epargne" placeholder="0 MGA" id="solde_epargne" onblur="formatFinancialField(this)"></label>
        <label>Caisse<input type="text" name="Caisse" placeholder="0 MGA" id="Caisse" onblur="formatFinancialField(this)"></label>
        <label>Échéances banque / IMF<input type="text" name="echeances" placeholder="0 MGA" id="echeances" onblur="formatFinancialField(this)"></label>
        <label>Encours de crédit<input type="text" name="encours_credit" placeholder="0 MGA" id="encours_credit" onblur="formatFinancialField(this)"></label>
        <label>Banque / IMF<select name="banque_imf"><option value="">-- Sélectionner --</option><option>BOA</option><option>SGM</option><option>BNI</option><option>BMOI</option><option>SBM</option><option>MCB</option><option>SMMEC</option><option>BBM</option><option>ABM</option><option>SIPEM</option><option>BF</option><option>ACEP</option><option>OTIV</option><option>CECAM</option><option>APEM</option><option>PAMF</option><option>Autres</option></select></label>
      </div>
    </fieldset>
  </div>
</fieldset>

<fieldset>
  <legend id="legend_activite"><i class="fas fa-chart-bar"></i> FONCTIONNEMENT DE L'ACTIVITE
    <button type="button" id="btn_toggle_fonctionnement" onclick="toggleFonctionnement()"><i class="fas fa-eye-slash"></i> Masquer</button>
  </legend>
  <div id="activite-wrapper">
    <div class="activite-tabs" id="activite-tabs">
      <div class="activite-tab active" onclick="switchActivite(1)">Activité 1</div>
      <div class="activite-tab" onclick="switchActivite(2)">Activité 2</div>
    </div>
    <div id="activite1-content" class="activite-content active">
      <div class="grid-2">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <label>Nom de l'activité (1ère ligne) :<input type="text" id="nom_activite_premiere_ligne" readonly></label>
          <label>Marge de l'activité (1ère ligne) :<input type="text" id="marge_activite_premiere_ligne" readonly></label>
          <div class="section-title">1 - Chiffre d'affaires mensuel :</div>
          <label>Fréquence de vente (par mois) :<input type="number" id="frequence_vente" min="0" placeholder="0"></label>
          <label>Vente selon derniers jours :</label>
          <div class="flex-row">
            <input type="text" id="vente_jour_v3" placeholder="V-3">
            <input type="text" id="vente_jour_v2" placeholder="V-2">
            <input type="text" id="vente_jour_v1" placeholder="V-1">
            <input type="text" id="vente_mensuelle" placeholder="Vente mensuelle" readonly class="readonly-input">
          </div>
          <label>Vente selon registre :</label>
          <div class="flex-row">
            <input type="text" id="vente_registre_m3" placeholder="M-3">
            <input type="text" id="vente_registre_m2" placeholder="M-2">
            <input type="text" id="vente_registre_m1" placeholder="M-1">
            <input type="text" id="vente_registre_mensuelle" placeholder="Vente mens RV" readonly class="readonly-input" style="color:darkgreen;">
          </div>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <label for="ca_ligne1" style="width: 150px;">CA (ligne 1) :</label>
            <input type="text" id="ca_ligne1" name="ca_ligne1" readonly class="resultat-bilan">
          </div>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <label for="creances_actuelles" style="width: 150px;">Créances actuelles</label>
            <input type="text" id="creances_actuelles" name="creances_actuelles">
          </div>
          <div class="section-title">2-CAMV mensuel :</div>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 10px;">
          <label style="font-weight:bold; color: darkred;">Croisements</label>
          <textarea id="croisements" placeholder="Saisissez ici vos croisements" class="notes-box" style="resize: both; overflow: auto; width:90%; max-width:90%;"></textarea>
          <label style="font-weight:bold; color: darkred;">Notes</label>
          <textarea id="notes" placeholder="Insérez ici vos notes et remarques" class="notes-box" style="resize: both; overflow: auto; width:90%; max-width:90%;"></textarea>
        </div>
        <label>Fréquence d'achat (par mois) :<input type="number" id="frequence_achat" min="0" placeholder="0"></label>
      </div>
      <label>Achat max/min/CAMV Mensuel:</label>
      <div class="flex-row" style="width: 45%;">
        <input type="text" id="achat_max" placeholder="max">
        <input type="text" id="achat_min" placeholder="min">
        <input type="text" id="camv_mensuel" placeholder="CAMV Mensuel" readonly class="readonly-input">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="camv_selon_marge" style="width: 150px; font-weight: bold;">CAMV selon marge</label>
        <input type="text" id="camv_selon_marge" name="camv_selon_marge" readonly class="blue-box" style="width: 30%;">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="camv_selon_mmp" style="width: 150px; font-weight: bold;">CAMV selon MMP</label>
        <input type="text" id="camv_selon_mmp" name="camv_selon_mmp" readonly class="blue-box" style="width: 30%;">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="camv_final" style="width: 150px; font-weight: bold;">CAMV final</label>
        <input type="text" id="camv_final" name="camv_final" readonly class="blue-box resultat-final" style="background-color:#696969; color:white; font-weight:bold;">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="dettes_fournisseurs" style="width: 160px;">Dettes fournisseurs</label>
        <input type="text" id="dettes_fournisseurs" name="dettes_fournisseurs" style="width:250px;">
      </div>
      <div class="section-title">3-OPEX (Operating Expenses ou dépenses d'exploitation)</div>
      <div class="opex-wrapper">
        <table class="opex-table">
          <thead><tr><th>Dépense</th><th>Montant (MGA)</th></tr></thead>
          <tbody>
            <tr><td>Transport sur achat</td><td><input type="text" class="opex-input" /></td></tr>
            <tr><td>Location</td><td><input type="text" class="opex-input" /></td></tr>
            <tr><td>Salaire</td><td><input type="text" class="opex-input" /></td></tr>
            <tr><td>Eau et électricité</td><td><input type="text" class="opex-input" /></td></tr>
            <tr><td>Impôt / Taxes</td><td><input type="text" class="opex-input" /></td></tr>
            <tr><td>Imprévus</td><td><input type="text" class="opex-input" /></td></tr>
            <tr><td><input type="text" class="opex-input" placeholder="Autres" style="height:40px;" /></td><td><input type="text" class="opex-input" style="height:40px;" /></td></tr>
            <tr class="opex-total"><td>Total OPEX</td><td><span id="opex-total">0 MGA</span></td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="activite2-content" class="activite-content">
      <div class="grid-2">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <label>Nom de l'activité (2ème ligne) :<input type="text" id="nom_activite_deuxieme_ligne" readonly></label>
          <label>Marge de l'activité (2ème ligne) :<input type="text" id="marge_activite_deuxieme_ligne" readonly></label>
          <div class="section-title">1-Chiffre d'affaires mensuel :</div>
          <label>Fréquence de vente (par mois) :<input type="number" id="frequence_vente2" min="0" placeholder="0"></label>
          <label>Vente selon derniers jours :</label>
          <div class="flex-row">
            <input type="text" id="vente_jour_v3_2" placeholder="V-3">
            <input type="text" id="vente_jour_v2_2" placeholder="V-2">
            <input type="text" id="vente_jour_v1_2" placeholder="V-1">
            <input type="text" id="vente_mensuelle2" placeholder="Vente mensuelle" readonly class="readonly-input">
          </div>
          <label>Vente selon registre :</label>
          <div class="flex-row">
            <input type="text" id="vente_registre_m3_2" placeholder="M-3">
            <input type="text" id="vente_registre_m2_2" placeholder="M-2">
            <input type="text" id="vente_registre_m1_2" placeholder="M-1">
            <input type="text" id="vente_registre_mensuelle2" placeholder="Vente mens RV" readonly class="readonly-input" style="color:darkgreen;">
          </div>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <label for="ca_ligne2" style="width: 150px;">CA (ligne 2) :</label>
            <input type="text" id="ca_ligne2" name="ca_ligne2" readonly class="resultat-bilan">
          </div>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <label for="creances_actuelles2" style="width: 150px;">Créances actuelles</label>
            <input type="text" id="creances_actuelles2" name="creances_actuelles2">
          </div>
          <div class="section-title">2-CAMV mensuel :</div>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 10px;">
          <label style="font-weight:bold; color: darkred;">Croisements</label>
          <textarea id="croisements2" placeholder="Saisissez ici vos croisements" class="notes-box" style="resize: both; overflow: auto; width:90%; max-width:90%;"></textarea>
          <label style="font-weight:bold; color: darkred;">Notes</label>
          <textarea id="notes2" placeholder="Insérez ici vos notes et remarques" class="notes-box" style="resize: both; overflow: auto; width:90%; max-width:90%;"></textarea>
        </div>
        <label>Fréquence d'achat (par mois) :<input type="number" id="frequence_achat2" min="0" placeholder="0"></label>
      </div>
      <label>Achat max/min/CAMV Mensuel:</label>
      <div class="flex-row" style="width: 45%;">
        <input type="text" id="achat_max2" placeholder="max">
        <input type="text" id="achat_min2" placeholder="min">
        <input type="text" id="camv_mensuel2" placeholder="CAMV Mensuel" readonly class="readonly-input">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="camv_selon_marge2" style="width: 150px; font-weight: bold;">CAMV selon marge</label>
        <input type="text" id="camv_selon_marge2" name="camv_selon_marge2" readonly class="blue-box" style="width: 30%;">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="camv_final2" style="width: 150px; font-weight: bold;">CAMV final</label>
        <input type="text" id="camv_final2" name="camv_final2" readonly class="blue-box resultat-final" style="background-color:#696969; color:white; font-weight:bold;">
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="dettes_fournisseurs2" style="width: 160px;">Dettes fournisseurs</label>
        <input type="text" id="dettes_fournisseurs2" name="dettes_fournisseurs2" style="width:250px;">
      </div>
      <div class="section-title">3-OPEX (Operating Expenses ou dépenses d'exploitation)</div>
      <div class="opex-wrapper">
        <table class="opex-table">
          <thead><tr><th>Dépense</th><th>Montant (MGA)</th></tr></thead>
          <tbody>
            <tr><td>Transport sur achat</td><td><input type="text" class="opex-input2" /></td></tr>
            <tr><td>Location</td><td><input type="text" class="opex-input2" /></td></tr>
            <tr><td>Salaire</td><td><input type="text" class="opex-input2" /></td></tr>
            <tr><td>Eau et électricité</td><td><input type="text" class="opex-input2" /></td></tr>
            <tr><td>Impôt / Taxes</td><td><input type="text" class="opex-input2" /></td></tr>
            <tr><td>Imprévus</td><td><input type="text" class="opex-input2" /></td></tr>
            <tr><td><input type="text" class="opex-input2" placeholder="Autres" style="height:40px;" /></td><td><input type="text" class="opex-input2" style="height:40px;" /></td></tr>
            <tr class="opex-total"><td>Total OPEX</td><td><span id="opex-total2">0 MGA</span></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend id="legend_mmp"><i class="fas fa-chart-pie"></i> MARGE MOYENNE PONDÉRÉE (MMP)
    <button type="button" onclick="toggleMMP()">Masquer</button>
  </legend>
  <div id="mmp-wrapper">
    <table id="tableMMP">
      <thead><tr><th>Produits les plus vendus mensuels</th><th>Qté mensuelle vendue</th><th>Stock</th><th>Prix d'achat</th><th>Prix de vente</th><th>Montant achat</th><th>Montant vente</th><th>Montant stock</th></tr></thead>
      <tbody>
        <tr>
          <td><input type="text" placeholder="Produit"></td>
          <td><input type="number" class="qte" value="0"></td>
          <td><input type="number" class="stock" value="0"></td>
          <td><input type="text" class="achat" value="0"></td>
          <td><input type="text" class="vente" value="0"></td>
          <td class="montantAchat">0,00</td>
          <td class="montantVente">0,00</td>
          <td class="montantStock">0,00</td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="total-row"><td colspan="5" style="text-align: right;">TOTAL :</td><td id="totalAchat">0,00</td><td id="totalVente">0,00</td><td id="totalStock">0,00</td></tr>
        <tr class="mmp-row"><td colspan="8" style="text-align: right;">MMP = <span id="mmp">0,00</span></td></tr>
      </tfoot>
    </table>
    <button type="button" class="add-btn" onclick="ajouterProduit()">Ajouter produit</button>
  </div>
</fieldset>

<fieldset>
  <legend id="legend_actifs_immo"><i class="fas fa-landmark"></i> ACTIFS IMMOBILISES/GARANTIES
    <button type="button" onclick="toggleActifs()">Masquer</button>
  </legend>
  <div id="actifs-wrapper">
    <table id="table_garanties" border="1" style="border-collapse: collapse; margin-top: 10px; font-size: 11px;">
      <thead>
        <tr style="font-size: 10px;"><th>Désignations</th><th>Emplacement</th><th>Description</th><th>Marque</th><th>Immat°…</th><th>Garantie (Oui/Non)</th><th>Valeur d'achat</th><th>Valeur estimée</th><th>Décote (%)</th><th>Actif (Oui/Non)</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="7" style="text-align:right;font-weight:bold; font-size: 11px;">Total garanties :</td><td id="total_garanties" colspan="3" style="background-color:#555; color:white; font-weight:bold; text-align:left; font-size:11px;">0 MGA</td><td></td></tr>
        <tr><td colspan="7" style="text-align:right;font-weight:bold; font-size: 11px;">Total actifs :</td><td id="total_actifs" colspan="3" style="background-color:#ff8c00; color:white; font-weight:bold; text-align:left; font-size:11px;">0 MGA</td><td></td></tr>
      </tfoot>
    </table>
    <button type="button" id="ajouter_garantie" style="margin-top:10px; font-size: 11px;">Ajouter garantie</button>
    <button type="button" onclick="exportToExcel()" style="margin-top:10px; font-size:11px; background:#28a745; color:white; padding:5px 10px; cursor:pointer;">Exporter en Excel</button>
  </div>
</fieldset>

<fieldset style="width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box;">
  <legend id="depenses_familiales"><i class="fas fa-home"></i> DEPENSES FAMILIALES
    <button type="button" onclick="toggleDepenses()">Masquer</button>
  </legend>
  <div class="df-wrapper" id="df-wrapper">
    <table class="df-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">
      <thead><tr><th style="text-align: left; padding: 5px;">Dépenses familiales</th><th style="text-align: right; padding: 5px;">Montant (MGA)</th></tr></thead>
      <tbody>
        <tr><td>Alimentation</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Eau et électricité</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Loyer</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Connexion</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Communication</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Scolarité</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Frais de déplacement</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Santé (traitement)</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Loisirs</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Carburant</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td>Imprévus</td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr><td><input type="text" class="df-label" placeholder="Autres charges" style="width:100%; height:25px; padding:2px;"></td><td><input type="text" class="df-input" style="width:100%; height:25px; padding:2px;"></td></tr>
        <tr class="df-total" style="font-weight:bold; background-color:#696969; color:#fff;"><td style="text-align:left; padding:5px;">Total dépenses familiales</td><td style="text-align:left; padding:5px;"><span id="df-total">0 MGA</span></td></tr>
      </tbody>
    </table>
  </div>
</fieldset>

<fieldset style="width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box;">
  <legend id="croisement_specifique"><i class="fas fa-search"></i> CROISEMENT SPECIFIQUE
    <button type="button" onclick="toggleCroisement()">Masquer</button>
  </legend>
  <table border="1" style="width:100%; border-collapse: collapse; font-size: 13px; text-align:left;">
    <thead style="background:#f0f0f0; text-align:center;">
      <tr><th colspan="2">TRANSPORT NATIONAL</th><th colspan="2">TRANSPORT DE MARCHANDISES</th><th colspan="2">BUS ET TAXI-BROUSSE</th></tr>
    </thead>
    <tbody>
      <tr><td>Trajet</td><td><input type="text" name="trajet_nat"></td><td>Trajet</td><td><input type="text" name="trajet_march"></td><td>Trajet et N° ligne</td><td><input type="text" name="trajet_bus"></td></tr>
      <tr><td>Kilométrage du trajet A/R</td><td><input type="text" name="km_nat" class="thousands-separator"></td><td>Kilométrage du trajet A/R</td><td><input type="text" name="km_march" class="thousands-separator"></td><td>Versement par jour</td><td><input type="text" name="versement_bus" class="thousands-separator"></td></tr>
      <tr><td>Frais par voyage A/R</td><td><input type="text" name="frais_nat" class="thousands-separator"></td><td>Frais de transport/kg</td><td><input type="text" name="frais_march" class="thousands-separator"></td><td>Nombre de jours travaillés</td><td><input type="text" name="jours_bus" class="thousands-separator"></td></tr>
      <tr><td>Nombre moyen de voyages mensuels</td><td><input type="text" name="voyages_nat" class="thousands-separator"></td><td>Nombre moyen de voyages mensuels</td><td><input type="text" name="voyages_march" class="thousands-separator"></td><td rowspan="2" style="background:#696969; color:white; font-weight:bold;">CA moyen Bus</td><td rowspan="2"><input type="text" name="ca_bus" readonly class="result"></td></tr>
      <tr><td>Nombre de places payantes</td><td><input type="text" name="places_nat" class="thousands-separator"></td><td>Charge transportée par voyage (kg) A/R</td><td><input type="text" name="charge_march" class="thousands-separator"></td></tr>
      <tr><td>Consommation aux 100 km</td><td><input type="text" name="conso_nat" class="thousands-separator"></td><td>Consommation aux 100 km</td><td><input type="text" name="conso_march" class="thousands-separator"></td><td colspan="2"></td></tr>
      <tr><td>Prix actuel du litre de carburant</td><td><input type="text" name="prix_nat" class="thousands-separator"></td><td>Prix actuel du litre de carburant</td><td><input type="text" name="prix_march" class="thousands-separator"></td><td colspan="2"></td></tr>
      <tr><td style="background:#696969; color:white; font-weight:bold;">CA moyen Nat</td><td><input type="text" name="ca_nat" readonly class="result"></td><td style="background:#696969; color:white; font-weight:bold;">CA moyen M/ses</td><td><input type="text" name="ca_march" readonly class="result"></td><td colspan="2"></td></tr>
      <tr><td style="background:#696969; color:white; font-weight:bold;">Carburant Nat</td><td><input type="text" name="carburant_nat" readonly class="result"></td><td style="background:#696969; color:white; font-weight:bold;">Carburant M/ses</td><td><input type="text" name="carburant_march" readonly class="result"></td><td colspan="2"></td></tr>
    </tbody>
  </table>
</fieldset>

<fieldset style="width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box;">
  <legend id="cout_prod"><i class="fas fa-industry"></i> COÛT DE PRODUCTION<small>(À utiliser uniquement si l'activité est une activité de production)</small>
    <button type="button" class="toggle-btn" onclick="toggleSection()"><i class="fas fa-eye-slash"></i> Masquer</button>
  </legend>
  <div id="content_cout_prod">
    <table id="table_cout" border="1" style="border-collapse:collapse; width:100%; text-align:center;">
      <thead style="background:#f0f0f0;">
        <tr><th style="width:180px;">Matières premières</th><th colspan="2">Produit 1</th><th colspan="2">Produit 2</th><th colspan="2">Produit 3</th><th colspan="2">Produit 4</th><th colspan="2">Produit 5</th></tr>
        <tr><th></th><th>PU</th><th>Qté</th><th>PU</th><th>Qté</th><th>PU</th><th>Qté</th><th>PU</th><th>Qté</th><th>PU</th><th>Qté</th></tr>
      </thead>
      <tbody id="tbody_matieres">
        <tr><td><input type="text" value="Tissus (m)"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td></tr>
        <tr><td><input type="text" value="Fil"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td></tr>
        <tr><td><input type="text" value="Étiquette (pièces)"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td></tr>
      </tbody>
      <tfoot style="font-weight:bold; background:#e6f2ff; text-align:center;">
        <tr><td>Coût total</td><td colspan="2" id="cout1">0</td><td colspan="2" id="cout2">0</td><td colspan="2" id="cout3">0</td><td colspan="2" id="cout4">0</td><td colspan="2" id="cout5">0</td></tr>
        <tr><td>Quantités produites</td><td colspan="2"><input type="number" id="qte1" oninput="calculer()" style="text-align:center;"></td><td colspan="2"><input type="number" id="qte2" oninput="calculer()" style="text-align:center;"></td><td colspan="2"><input type="number" id="qte3" oninput="calculer()" style="text-align:center;"></td><td colspan="2"><input type="number" id="qte4" oninput="calculer()" style="text-align:center;"></td><td colspan="2"><input type="number" id="qte5" oninput="calculer()" style="text-align:center;"></td></tr>
        <tr style="background:#ccffcc; color:red; text-align:center;"><td>Coût unitaire/produit</td><td colspan="2" id="unit1">0</td><td colspan="2" id="unit2">0</td><td colspan="2" id="unit3">0</td><td colspan="2" id="unit4">0</td><td colspan="2" id="unit5">0</td></tr>
      </tfoot>
    </table>
    <button onclick="ajouterMat()" style="margin-top:10px; padding:5px 15px; font-size:16px;">Ajouter matière 1ère</button>
  </div>
</fieldset>

<fieldset style="width:100%; margin:0 auto; padding:10px; box-sizing:border-box;">
  <legend id="legend_bilan"><i class="fas fa-file-invoice fa-lg"></i> BILAN
    <button type="button" class="toggle-btn" onclick="toggleBilan()"><i class="fas fa-eye-slash"></i> Masquer</button>
  </legend>
  <div id="content_bilan">
    <table id="table_bilan" border="1" style="border-collapse:collapse; width:100%; text-align:center; font-size:12px;">
      <thead style="background:#f0f0f0;"><tr><th>ACTIF</th><th>Analyse actuelle</th><th>Crédit antérieur ACTIF</th><th>PASSIF</th><th>Analyse actuelle</th><th>Crédit antérieur PASSIF</th></tr></thead>
      <tbody>
        <tr><td>Trésorerie activité</td><td><input type="text" id="bilan_caisse" readonly class="result numeric"></td><td><input type="text" class="credit-avant-actif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td><td>Dettes fournisseurs</td><td><input type="text" id="bilan_dettes_fourn" readonly class="result numeric"></td><td><input type="text" class="credit-avant-passif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>Trésorerie hors activité</td><td><input type="text" id="bilan_treso_hors_act" readonly class="result numeric"></td><td><input type="text" class="credit-avant-actif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td><td>Dettes CT (encours)</td><td><input type="text" id="bilan_encours" readonly class="result numeric"></td><td><input type="text" class="credit-avant-passif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>Créances</td><td><input type="text" id="bilan_creances" readonly class="result numeric"></td><td><input type="text" class="credit-avant-actif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td><td>Dettes LT</td><td><input type="text" id="bilan_dettes_lt" class="numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td><td><input type="text" class="credit-avant-passif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>Stock</td><td><input type="text" id="bilan_stock" readonly class="result numeric"></td><td><input type="text" class="credit-avant-actif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td><td>Fonds propres</td><td><input type="text" id="bilan_fonds_propres" readonly class="result numeric"></td><td><input type="text" class="credit-avant-passif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>Actif immobilisé</td><td><input type="text" id="bilan_actif_immo" readonly class="result numeric"></td><td><input type="text" class="credit-avant-actif numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td><td style="background:#696969; color:#fff; font-weight:bold;">Total passif</td><td style="background:#696969; color:#fff; font-weight:bold;"><input type="text" id="bilan_total_passif" readonly class="result numeric" style="background:#696969; color:#fff;"></td><td style="background:#696969; color:#fff; font-weight:bold;"><input type="text" id="bilan_total_passif_avant" readonly class="result numeric" style="background:#696969; color:#fff;"></td></tr>
        <tr style="background:#696969; color:#fff; font-weight:bold;"><td style="background:#696969; color:#fff; font-weight:bold;">Total actif</td><td style="background:#696969; color:#fff; font-weight:bold;"><input type="text" id="bilan_total_actif" readonly class="result numeric" style="background:#696969; color:#fff;"></td><td style="background:#696969; color:#fff; font-weight:bold;"><input type="text" id="bilan_total_actif_avant" readonly class="result numeric" style="background:#696969; color:#fff;"></td><td colspan="3"></td></tr>
      </tbody>
    </table>
  </div>
</fieldset>

<fieldset style="width:100%; margin:0 auto; padding:10px; box-sizing:border-box;">
  <legend id="legend_cashflow"><i class="fas fa-chart-line fa-lg"></i> CASH FLOW
    <button type="button" class="toggle-btn" onclick="toggleCashFlow()"><i class="fas fa-eye-slash"></i> Masquer</button>
  </legend>
  <div id="content_cashflow">
    <table id="table_cashflow" border="1" style="border-collapse:collapse; width:100%; font-size:12px;">
      <thead style="background:#f0f0f0; text-align:center;"><tr><th style="width:20%;">Analyse actuelle</th><th style="width:20%;">CONSOLIDE</th><th style="width:20%;">Activité 1 </th><th style="width:20%;">Activité 2 </th><th style="width:20%;">Analyse antérieure</th></tr></thead>
      <tbody style="text-align:left;">
        <tr><td>Chiffre d'affaires Mensuel</td><td><input type="text" id="CA_mensuel" readonly class="result numeric"></td><td><input type="text" id="CA_activité1" readonly class="result numeric"></td><td><input type="text" id="CA_activité2" readonly class="result numeric"></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>Coût d'achat des marchandises vendues (CAMV)</td><td><input type="text" id="CAMV_mensuel" readonly class="result numeric"></td><td><input type="text" id="CAMV_activité1" readonly class="result numeric"></td><td><input type="text" id="CAMV_activité2" readonly class="result numeric"></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row"><td>CASH FLOW BRUT</td><td><input type="text" id="Cash_flow_brut" readonly class="result numeric" style="background-color: orange; color: white; font-weight: bold;"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>Total OPEX</td><td><input type="text" id="Total_opex" readonly class="result numeric"></td><td><input type="text" id="Total_opex1" readonly class="result numeric"></td><td><input type="text" id="Total_opex2" readonly class="result numeric"></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row"><td>CASH FLOW NET</td><td><input type="text" id="Cash_flow_net" readonly class="result numeric" style="background-color: orange; color: white; font-weight: bold;"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row"><td>ECHEANCES DE CREDIT</td><td><input type="text" id="echeances_credit" readonly class="result numeric"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row"><td>AUTRES REVENUS</td><td><input type="text" id="Autres_revenus" readonly class="result numeric"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row"><td>DEPENSES FAMILIALES</td><td><input type="text" id="Depenses_familiales" readonly class="result numeric"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row"><td>CASH FLOW</td><td><input type="text" id="Cash_flow" readonly class="result numeric" style="background-color: #003366; color: white; font-weight: bold;"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr><td>DSCR = 50%</td><td><input type="text" id="DSCR" readonly class="result numeric" style="background-color: #d3d3d3; color: black; font-weight: bold;"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
        <tr class="bold-row red-text"><td>Mensualité proposée</td><td><input type="text" id="mensualite_proposee" readonly class="result numeric" placeholder="0 MGA" style="background-color: orange; color: white; font-weight: bold;"></td><td></td><td></td><td><input type="text" class="credit-anterieur numeric" placeholder="0 MGA" onblur="formatFinancialField(this)"></td></tr>
      </tbody>
    </table>
  </div>
</fieldset>

<fieldset>
  <legend id="legend_ratios"><i class="fas fa-balance-scale"></i> RATIOS
    <button type="button" onclick="toggleRatios()">Masquer</button>
  </legend>
  <div id="ratios-wrapper">
    <div class="ratios-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px 20px;">
      <div><span class="mini-legend">Ratio de rotation de stock</span><input type="text" id="ratio_stock" name="ratio_stock" readonly class="blue-box" style="width: 90%;"></div>
      <div><span class="mini-legend">Ratio d'endettement CT <1</span><input type="text" id="ratio_endettement" name="ratio_endettement" readonly class="blue-box" style="width: 90%;"></div>
      <div><span class="mini-legend">Ratio de liquidité >1,5</span><input type="text" id="ratio_liquidite" name="ratio_liquidite" readonly class="blue-box" style="width: 90%;"></div>
      <div><span class="mini-legend">Ratio de solvabilité >1</span><input type="text" id="ratio_solvabilite" name="ratio_solvabilite" readonly class="blue-box" style="width: 90%;"></div>
      <div><span class="mini-legend">DSCR <=50%</span><input type="text" id="dscr" name="dscr" readonly class="blue-box" style="width: 90%;"></div>
      <div><span class="mini-legend">Couverture de garanties >=125%</span><input type="text" id="couverture_garanties" name="couverture_garanties" readonly class="blue-box" style="width: 90%;"></div>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend id="legend_propo"><i class="fas fa-chart-pie"></i> PROPOSITION AC/DECISION COMITE
    <button type="button" onclick="togglePropo()">Masquer</button>
  </legend>
  <div id="propo-wrapper">
    <table id="tablePropo">
      <thead><tr><th></th><th>Montant</th><th>Durée (mois)</th><th>Mensualité proposée</th></tr></thead>
      <tbody>
        <tr><th>Proposition AC</th><td><input type="text" name="montant_ac" class="thousands-separator" style="text-align:center;"></td><td><input type="text" name="duree_ac" class="thousands-separator" style="text-align:center;"></td><td><input type="text" id="mensualite_ac" readonly class="blue-box" style="text-align:center;"></td></tr>
        <tr><th>Décision comité</th><td><input type="text" name="montant_comite" class="thousands-separator" style="text-align:center;"></td><td><input type="text" name="duree_comite" class="thousands-separator" style="text-align:center;"></td><td><input type="text" id="mensualite_comite" readonly class="blue-box" style="text-align:center;"></td></tr>
      </tbody>
    </table>
  </div>
</fieldset>

<fieldset style="width:100%; margin-top:20px; padding:10px; box-sizing:border-box;">
    <legend id="legend_references">
      <i class="fas fa-user-friends"></i> REFERENCES MORALES ET PROFESSIONNELLES
      <button type="button" id="btnToggleReferences" onclick="toggleReferences()" style="margin-left:10px;">Masquer</button>
    </legend>

    <div id="references-wrapper">
      <table id="table_references" style="width:100%; border-collapse:collapse; text-align:center;">
        <thead style="background-color:#2E8B57; color:black;">
          <tr>
            <th style="width:3%;">N°</th>
            <th style="width:25%;">Nom et prénoms</th>
            <th style="width:15%;">Relation avec le demandeur</th>
            <th style="width:15%;">Contact</th>
            <th style="width:20%;">Adresse</th>
            <th style="width:5%;">🗑</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><input type="text" name="nom_reference[]" style="width:95%;" required></td>
            <td>
              <select name="relation_reference[]" style="width:95%;" required>
                <option value="">-- Sélectionner --</option>
                <option value="Ami">Ami(e)</option>
                <option value="Famille">Famille</option>
                <option value="Époux(se)">Époux(se)</option>
                <option value="Frère">Frère</option>
                <option value="Sœur">Sœur</option>
                <option value="Parent">Parent</option>
                <option value="Fils">Fils</option>
                <option value="Fille">Fille</option>
                <option value="Autres">Autres</option>
              </select>
            </td>
            <td>
              <input type="text" name="contact_reference[]" required
                     placeholder="xxx xx xxx xx" style="width:95%; text-align:center;"
                     oninput="maskContact(this)" onkeydown="onlyDigits(event)">
            </td>
            <td><input type="text" name="adresse_reference[]" style="width:95%;" required></td>
            <td><button type="button" onclick="supprimerLigneRef(this)">🗑</button></td>
          </tr>
          <tr>
            <td>2</td>
            <td><input type="text" name="nom_reference[]" style="width:95%;" required></td>
            <td>
              <select name="relation_reference[]" style="width:95%;" required>
                <option value="">-- Sélectionner --</option>
                <option value="Ami">Ami(e)</option>
                <option value="Famille">Famille</option>
                <option value="Époux(se)">Époux(se)</option>
                <option value="Frère">Frère</option>
                <option value="Sœur">Sœur</option>
                <option value="Parent">Parent</option>
                <option value="Fils">Fils</option>
                <option value="Fille">Fille</option>
                <option value="Autres">Autres</option>
              </select>
            </td>
            <td>
              <input type="text" name="contact_reference[]" required
                     placeholder="xxx xx xxx xx" style="width:95%; text-align:center;"
                     oninput="maskContact(this)" onkeydown="onlyDigits(event)">
            </td>
            <td><input type="text" name="adresse_reference[]" style="width:95%;" required></td>
            <td><button type="button" onclick="supprimerLigneRef(this)">🗑</button></td>
          </tr>
          <tr>
            <td>3</td>
            <td><input type="text" name="nom_reference[]" style="width:95%;" required></td>
            <td>
              <select name="relation_reference[]" style="width:95%;" required>
                <option value="">-- Sélectionner --</option>
                <option value="Ami">Ami(e)</option>
                <option value="Famille">Famille</option>
                <option value="Époux(se)">Époux(se)</option>
                <option value="Frère">Frère</option>
                <option value="Sœur">Sœur</option>
                <option value="Parent">Parent</option>
                <option value="Fils">Fils</option>
                <option value="Fille">Fille</option>
                <option value="Autres">Autres</option>
              </select>
            </td>
            <td>
              <input type="text" name="contact_reference[]" required
                     placeholder="xxx xx xxx xx" style="width:95%; text-align:center;"
                     oninput="maskContact(this)" onkeydown="onlyDigits(event)">
            </td>
            <td><input type="text" name="adresse_reference[]" style="width:95%;" required></td>
            <td><button type="button" onclick="supprimerLigneRef(this)">🗑</button></td>
          </tr>
          <tr>
            <td>4</td>
            <td><input type="text" name="nom_reference[]" style="width:95%;" required></td>
            <td>
              <select name="relation_reference[]" style="width:95%;" required>
                <option value="">-- Sélectionner --</option>
                <option value="Ami">Ami(e)</option>
                <option value="Famille">Famille</option>
                <option value="Époux(se)">Époux(se)</option>
                <option value="Frère">Frère</option>
                <option value="Sœur">Sœur</option>
                <option value="Parent">Parent</option>
                <option value="Fils">Fils</option>
                <option value="Fille">Fille</option>
                <option value="Autres">Autres</option>
              </select>
            </td>
            <td>
              <input type="text" name="contact_reference[]" required
                     placeholder="xxx xx xxx xx" style="width:95%; text-align:center;"
                     oninput="maskContact(this)" onkeydown="onlyDigits(event)">
            </td>
            <td><input type="text" name="adresse_reference[]" style="width:95%;" required></td>
            <td><button type="button" onclick="supprimerLigneRef(this)">🗑</button></td>
          </tr>
        </tbody>
      </table>

      <div style="margin-top:10px;">
        <button type="button" onclick="ajouterLigneReference()" style="background-color:#2E8B57; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
          ➕ Ajouter une ligne
        </button>
      </div>
    </div>
  </fieldset>
  
  <fieldset style="width:100%; margin-top:20px; padding:10px; box-sizing:border-box;">
  <legend id="legend_risques">
    <i class="fas fa-exclamation-triangle"></i> RISQUES
    <button type="button" id="btnToggleRisques" onclick="toggleRisques()" style="margin-left:10px;">Masquer</button>
  </legend>

  <div id="risques-wrapper">
    <table id="table_risques" style="width:100%; border-collapse:collapse; text-align:center;">
      <thead style="background-color:#2E8B57; color:black;">
        <tr>
          <th style="width:40%;">Risques identifiés</th>
          <th style="width:20%;">Niveau du Risque</th>
          <th style="width:35%;">Mitigation des risques</th>
          <th style="width:5%;">🗑</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><textarea name="risque[]" style="width:95%; resize:none; overflow:hidden;" required oninput="autoResize(this)"></textarea></td>
          <td>
            <select name="niveau_risque[]" style="width:95%;" required>
              <option value="">-- Sélectionner --</option>
              <option value="Faible">Faible</option>
              <option value="Moyen">Moyen</option>
              <option value="Élevé">Élevé</option>
            </select>
          </td>
          <td><textarea name="mitigation[]" style="width:95%; resize:none; overflow:hidden;" required oninput="autoResize(this)"></textarea></td>
          <td><button type="button" onclick="supprimerLigneRisque(this)">🗑</button></td>
        </tr>
      </tbody>
    </table>

    <div style="margin-top:10px;">
      <button type="button" onclick="ajouterLigneRisque()" 
              style="background-color:#2E8B57; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
        ➕ Ajouter ligne risque
      </button>
    </div>
  </div>
</fieldset>

<fieldset style="width:100%; margin-top:20px; padding:10px; box-sizing:border-box;">
  <legend id="legend_points">
    <i class="fas fa-map-marker-alt"></i> POINTS D'ATTACHE : Où est ce qu'on peut trouver le client s'il disparait? Quel est notre moyen de prise?
    <button type="button" id="btnTogglePoints" onclick="togglePoints()" style="margin-left:10px;">Masquer</button>
  </legend>

  <div id="point-wrapper">
    <textarea id="pointsTextarea" 
              style="width:100%; resize:none; overflow:hidden; padding:5px; box-sizing:border-box;" 
              placeholder="Saisir les points d'attache ici..." 
              oninput="autoResize(this)">
    </textarea>
  </div>
</fieldset>

  
<button type="button" class="submit-btn" onclick="genererSynthesePDF()"><i class="fas fa-file-pdf"></i> Synthèse de crédit en PDF</button>
<button type="button" class="submit-btn" onclick="copierEtSauvegarder()"><i class="fas fa-copy"></i> Copier et Sauvegarder</button>
</form>

<script>
const ACTIVITES_MARGES = {
  "Epicerie": "16%", "Epi-bar": "23%", "Boulangerie": "5%", "Pâtisserie": "25%", "Menuiserie": "30%",
  "Murisserie de banane": "8%", "Confection": "25%", "Collecteurs produits riz": "7%", "Collecteurs produits locaux": "20%",
  "Poissonnerie": "15%", "Commerce Provende animale": "18%", "Vente cosmétiques": "20%", "Quincailleries": "18%",
  "Pharmacie": "12%", "Vente de pneus": "14%", "Taxiphone = vente de carte": "5%", "Vente d'articles divers": "15%",
  "Vente de fourniture scolaire": "18%", "Multiservices": "0%", "Pièces pour véhicules, accessoires": "23%",
  "Pièces pour moto, accessoires": "15%", "Pièces pour bicyclette, accessoires": "15%", "Fruits et légumes": "15%",
  "Boucherie : viande bovine, porcine et volaille de chair, charcuterie": "18%", "Production yaourt": "35%",
  "Vente Vêtement: produits neufs": "23%", "Vente chaussures: produits neufs": "30%", "Vêtement chaussures: produits usés": "25%",
  "Vêtement textiles: produits usés": "18%", "Grossiste PPN": "5%", "Bijouterie": "23%", "Lapidaire": "35%",
  "Vente produit en plastique": "13%", "Vente produit laitier": "10%", "Vente d'œuf": "10%", "Kafé sy mofo": "60%",
  "Grillade/Snack": "50%", "Location maison": "0%", "Gargote": "50%", "Restaurant": "60%", "Poulets de chair": "20%",
  "Poules pondeuses": "21%", "Vente de riz blanc en gros": "15%", "Vente de riz blanc au détail": "30%",
  "Vente de poissons secs en gros": "23%", "Vente de poissons secs au détail": "28%", "Vente de produits locaux en gros": "18%",
  "Vente de produits locaux au détail": "40%", "Cordonnier et réparateur de chaussures": "0%", "Coiffure et esthétique": "0%",
  "Vulca – Service de Réparation de Pneus": "0%", "Cybercafé": "0%", "Dépôt de médicament": "0%",
  "Cliniques de soins de base": "0%", "Ecole": "0%", "Location voiture": "0%", "Tranport des personnes": "0%",
  "Transport des marchandises": "0%", "Taxi-ville": "0%", "Taxi-moto": "0%", "Autres services": "0%",
  "Cyclo-pousse": "0%", "Pousse-pousse": "0%", "Tuc-tuc": "0%"
};

function fmt0(n){ return (Number(n) || 0).toLocaleString('fr-FR', {maximumFractionDigits:0}); }
function fmtMGA(n){ return fmt0(n) + " MGA"; }
function parseNumberFromString(s){
  if(!s) return 0;
  const digits = String(s).replace(/\s|MGA|[^\d\.,-]/g,'').replace(',', '.');
  const num = parseFloat(digits);
  return isNaN(num) ? 0 : num;
}
function formatNombre(n){ return (Number(n)||0).toLocaleString("fr-FR", { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
function formatThousands(input) {
  if (!input) return;
  const start = input.selectionStart;
  const end = input.selectionEnd;
  let value = input.value.replace(/[^\d]/g, '');
  if (value) value = parseInt(value, 10).toLocaleString('fr-FR');
  input.value = value;
  const newLength = input.value.length;
  const diff = newLength - input.value.replace(/[^\d]/g, '').length;
  input.setSelectionRange(start + diff, end + diff);
}
function removeThousandsSeparator(value) { return value.replace(/\s/g, ''); }

function ajouterLigne(){
  const tbody = document.getElementById('tbody_objet');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" name="libelle[]" required></td><td><input type="text" name="montant_objet[]" value="" oninput="updateTotalDepuisObjet(this)" onblur="formatMontantObjet(this)" /></td><td><button type="button" class="del-btn" onclick="supprimerLigne(this)">Supprimer</button></td>`;
  tbody.appendChild(tr);
}
function supprimerLigne(btn){ btn.closest('tr')?.remove(); updateTotalDepuisObjet(); }
function formatMontantObjet(input){
  if(!input) return;
  const n = parseNumberFromString(input.value);
  input.value = n>0 ? fmtMGA(n) : "";
  updateTotalDepuisObjet();
}
function updateTotalDepuisObjet(){
  let total = 0;
  document.querySelectorAll('input[name="montant_objet[]"]').forEach(i=>{ total += parseNumberFromString(i.value); });
  const totalInput = document.getElementById('total_objet');
  totalInput.value = fmt0(total);
  totalInput.className = total>2575000 ? "warning" : "normal";
  document.getElementById('montant_demande').value = fmt0(total);
  document.getElementById('warning_total').innerText = total>2575000 ? "⚠ Le total dépasse 2 575 000 MGA !" : "";
}

function remplirSelectActivite(select){
  if(!select) return;
  select.innerHTML = '<option value="">--Sélectionner--</option>';
  Object.keys(ACTIVITES_MARGES).forEach(nom => {
    const opt = document.createElement('option');
    opt.value = nom; opt.textContent = nom; select.appendChild(opt);
  });
}

function ajouterActivite() {
  const tbody = document.getElementById('tbody_activite');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><select name="nom_activite[]" required></select></td><td><input type="text" name="marge_activite[]" readonly></td><td><input type="number" name="anciennete_activite[]" min="0" required></td><td><select name="secteur_activite[]" required><option value="">--Sélectionner--</option><option>Commerce</option><option>Élevage</option><option>Production</option><option>Salarié</option><option>Transport</option><option>Services</option></select></td><td><button type="button" class="del-btn" onclick="supprimerActivite(this)">Supprimer</button></td>`;
  tbody.appendChild(tr);
  const selectActivite = tr.querySelector('select[name="nom_activite[]"]');
  const inputMarge = tr.querySelector('input[name="marge_activite[]"]');
  remplirSelectActivite(selectActivite);
  selectActivite.addEventListener('change', function () {
    inputMarge.value = ACTIVITES_MARGES[this.value] || "0%";
    majNomActivitePremiereLigne(); majNomActiviteDeuxiemeLigne(); majMargeActivitePremiereLigne(); majMargeActiviteDeuxiemeLigne();
    majLegendActivite(); majCAMVSelonMarge(); majCAMVSelonMarge2(); majCAMVSelonMMP();
  });
}

function supprimerActivite(btn) { 
  btn.closest('tr')?.remove(); 
  majNomActivitePremiereLigne(); majNomActiviteDeuxiemeLigne(); majMargeActivitePremiereLigne(); majMargeActiviteDeuxiemeLigne();
  majLegendActivite(); majCAMVSelonMarge(); majCAMVSelonMarge2(); majCAMVSelonMMP();
}

function majNomActivitePremiereLigne(){
  const premiereActivite = document.querySelector('#tbody_activite tr:first-child select[name="nom_activite[]"]');
  document.getElementById('nom_activite_premiere_ligne').value = premiereActivite ? (premiereActivite.value||'') : '';
}
function majNomActiviteDeuxiemeLigne(){
  const deuxiemeActivite = document.querySelector('#tbody_activite tr:nth-child(2) select[name="nom_activite[]"]');
  document.getElementById('nom_activite_deuxieme_ligne').value = deuxiemeActivite ? (deuxiemeActivite.value||'') : '';
}
function majMargeActivitePremiereLigne() {
  const premiereActiviteMarge = document.querySelector('#tbody_activite tr:first-child input[name="marge_activite[]"]');
  document.getElementById('marge_activite_premiere_ligne').value = premiereActiviteMarge ? premiereActiviteMarge.value : '';
}
function majMargeActiviteDeuxiemeLigne() {
  const deuxiemeActiviteMarge = document.querySelector('#tbody_activite tr:nth-child(2) input[name="marge_activite[]"]');
  document.getElementById('marge_activite_deuxieme_ligne').value = deuxiemeActiviteMarge ? deuxiemeActiviteMarge.value : '';
}
function majLegendActivite(){}

function synchroniserCaution(){
  const lien = document.getElementById('lien_demandeur').value;
  if(lien === "Epoux(se)" || lien === "Concubin(e)"){
    document.getElementById('etat_civil_caution').value = document.getElementById('etat_civil_client').value;
    document.getElementById('nb_caution').value = document.getElementById('nb_client').value;
    document.getElementById('adresse_domicile_caution').value = document.getElementById('adresse_domicile_client').value;
  }
}

function majVenteMensuelle(){
  ['vente_jour_v3','vente_jour_v2','vente_jour_v1'].forEach(id=>formatInputMGA(document.getElementById(id), true));
  const v3 = parseNumberFromString(document.getElementById('vente_jour_v3').value);
  const v2 = parseNumberFromString(document.getElementById('vente_jour_v2').value);
  const v1 = parseNumberFromString(document.getElementById('vente_jour_v1').value);
  const freq = parseFloat(document.getElementById('frequence_vente').value) || 0;
  const moyenne = (v3 + v2 + v1) / 3;
  const resultat = Math.round(moyenne * freq);
  document.getElementById('vente_mensuelle').value = resultat>0 ? fmtMGA(resultat) : "";
  majCALigne1(); majCAMVSelonMarge();
}
function majVenteMensRV(){
  ['vente_registre_m3','vente_registre_m2','vente_registre_m1'].forEach(id=>formatInputMGA(document.getElementById(id), true));
  const m3 = parseNumberFromString(document.getElementById('vente_registre_m3').value);
  const m2 = parseNumberFromString(document.getElementById('vente_registre_m2').value);
  const m1 = parseNumberFromString(document.getElementById('vente_registre_m1').value);
  const moyenne = Math.round((m3 + m2 + m1) / 3);
  document.getElementById('vente_registre_mensuelle').value = moyenne>0 ? fmtMGA(moyenne) : "";
  majCALigne1(); majCAMVSelonMarge();
}
function majCALigne1(){
  const venteMensRV = parseNumberFromString(document.getElementById('vente_registre_mensuelle').value) || 0;
  const venteMensuelle = parseNumberFromString(document.getElementById('vente_mensuelle').value) || 0;
  const ca = (venteMensRV === 0) ? venteMensuelle : venteMensRV;
  document.getElementById('ca_ligne1').value = ca>0 ? fmtMGA(ca) : "";
}

function majVenteMensuelle2(){
  ['vente_jour_v3_2','vente_jour_v2_2','vente_jour_v1_2'].forEach(id=>formatInputMGA(document.getElementById(id), true));
  const v3 = parseNumberFromString(document.getElementById('vente_jour_v3_2').value);
  const v2 = parseNumberFromString(document.getElementById('vente_jour_v2_2').value);
  const v1 = parseNumberFromString(document.getElementById('vente_jour_v1_2').value);
  const freq = parseFloat(document.getElementById('frequence_vente2').value) || 0;
  const moyenne = (v3 + v2 + v1) / 3;
  const resultat = Math.round(moyenne * freq);
  document.getElementById('vente_mensuelle2').value = resultat>0 ? fmtMGA(resultat) : "";
  majCALigne2(); majCAMVSelonMarge2();
}
function majVenteMensRV2(){
  ['vente_registre_m3_2','vente_registre_m2_2','vente_registre_m1_2'].forEach(id=>formatInputMGA(document.getElementById(id), true));
  const m3 = parseNumberFromString(document.getElementById('vente_registre_m3_2').value);
  const m2 = parseNumberFromString(document.getElementById('vente_registre_m2_2').value);
  const m1 = parseNumberFromString(document.getElementById('vente_registre_m1_2').value);
  const moyenne = Math.round((m3 + m2 + m1) / 3);
  document.getElementById('vente_registre_mensuelle2').value = moyenne>0 ? fmtMGA(moyenne) : "";
  majCALigne2(); majCAMVSelonMarge2();
}
function majCALigne2(){
  const venteMensRV = parseNumberFromString(document.getElementById('vente_registre_mensuelle2').value) || 0;
  const venteMensuelle = parseNumberFromString(document.getElementById('vente_mensuelle2').value) || 0;
  const ca = (venteMensRV === 0) ? venteMensuelle : venteMensRV;
  document.getElementById('ca_ligne2').value = ca>0 ? fmtMGA(ca) : "";
}

function majCAMVMensuel(){
  ['achat_max','achat_min'].forEach(id=>formatInputMGA(document.getElementById(id), true));
  const max = parseNumberFromString(document.getElementById('achat_max').value);
  const min = parseNumberFromString(document.getElementById('achat_min').value);
  const freq = parseFloat(document.getElementById('frequence_achat').value) || 0;
  const moyenne = (max + min) / 2;
  const resultat = Math.round(moyenne * freq);
  document.getElementById('camv_mensuel').value = resultat>0 ? fmtMGA(resultat) : "0 MGA";
  majCALigne1(); majCAMVFinal();
}

function majCAMVSelonMarge(){
  let ca = parseNumberFromString(document.getElementById('ca_ligne1').value) || 0;
  let margeStr = document.getElementById('marge_activite_premiere_ligne').value || "0%";
  let marge = parseFloat(String(margeStr).replace('%','')) / 100;
  if (isNaN(marge)) marge = 0;
  let camv = 0;
  if (marge <= 0) { camv = 0; } else { camv = Math.round(ca / (1 + marge)); }
  document.getElementById('camv_selon_marge').value = camv > 0 ? fmtMGA(camv) : "0 MGA";
  majCAMVFinal();
}

function majCAMVSelonMMP() {
  const ca = parseNumberFromString(document.getElementById('ca_ligne1').value) || 0;
  const mmpElem = document.getElementById('mmp');
  let mmpStr = "0%";
  if (mmpElem) { mmpStr = (mmpElem.textContent || "0%").trim(); }
  let mmp = parseFloat(String(mmpStr).replace(/\s|%/g, '')) / 100;
  if (isNaN(mmp)) mmp = 0;
  let camvMMP = 0;
  if (mmp > 0) { camvMMP = Math.round(ca / (1 + mmp)); }
  const champ = document.getElementById('camv_selon_mmp');
  if (champ) champ.value = camvMMP > 0 ? fmtMGA(camvMMP) : "0 MGA";
  majCAMVFinal();
}

function majCAMVFinal() {
  const camvMensuel = parseNumberFromString(document.getElementById('camv_mensuel').value) || 0;
  const camvMarge   = parseNumberFromString(document.getElementById('camv_selon_marge').value) || 0;
  const camvMMP     = parseNumberFromString(document.getElementById('camv_selon_mmp').value) || 0;
  const camvFinal = Math.max(camvMensuel, camvMarge, camvMMP);
  const champ = document.getElementById('camv_final');
  if (champ) champ.value = camvFinal > 0 ? fmtMGA(camvFinal) : "0 MGA";
}

function majCAMVMensuel2(){
  ['achat_max2','achat_min2'].forEach(id=>formatInputMGA(document.getElementById(id), true));
  const max = parseNumberFromString(document.getElementById('achat_max2').value);
  const min = parseNumberFromString(document.getElementById('achat_min2').value);
  const freq = parseFloat(document.getElementById('frequence_achat2').value) || 0;
  const moyenne = (max + min) / 2;
  const resultat = Math.round(moyenne * freq);
  document.getElementById('camv_mensuel2').value = resultat>0 ? fmtMGA(resultat) : "0 MGA";
  majCALigne2(); majCAMVFinal2();
}
function majCAMVSelonMarge2(){
  let ca = parseNumberFromString(document.getElementById('ca_ligne2').value) || 0;
  let margeStr = document.getElementById('marge_activite_deuxieme_ligne').value || "0%";
  let marge = parseFloat(String(margeStr).replace('%',''))/100;
  if(isNaN(marge)) marge = 0;
  let camv = 0;
  if(marge <= 0){ camv = 0; } else { camv = Math.round(ca / (1 + marge)); }
  document.getElementById('camv_selon_marge2').value = camv > 0 ? fmtMGA(camv) : "0 MGA";
  majCAMVFinal2();
}
function majCAMVFinal2(){
  const camvMensuel = parseNumberFromString(document.getElementById('camv_mensuel2').value) || 0;
  const camvMarge   = parseNumberFromString(document.getElementById('camv_selon_marge2').value) || 0;
  const camvFinal = Math.max(camvMensuel, camvMarge);
  document.getElementById('camv_final2').value = camvFinal>0 ? fmtMGA(camvFinal) : "0 MGA";
}

function updateOpexTotal(){
  let total = 0;
  document.querySelectorAll('.opex-input').forEach(input => { total += parseNumberFromString(input.value); });
  document.getElementById('opex-total').textContent = fmtMGA(total);
}

function updateOpexTotal2(){
  let total = 0;
  document.querySelectorAll('.opex-input2').forEach(input => { total += parseNumberFromString(input.value); });
  document.getElementById('opex-total2').textContent = fmtMGA(total);
}

function formatInputMGA(el, keepSuffix=false){
  if(!el) return;
  let raw = String(el.value || "");
  let digits = raw.replace(/[^\d\.-]/g,'');
  if(digits === "" || digits === "-" || digits === ".") { el.value = ""; return; }
  const num = parseFloat(digits);
  if(isNaN(num)){ el.value = ""; return; }
  el.value = keepSuffix ? fmtMGA(num) : String(Math.round(num));
}

function bindMMPRow(tr){
  const qte = tr.querySelector('.qte');
  const stock = tr.querySelector('.stock');
  const achat = tr.querySelector('.achat');
  const vente = tr.querySelector('.vente');
  [qte, stock].forEach(el=>{ if(!el) return; el.addEventListener('input', function() { calculerMMP(); }); });
  [achat, vente].forEach(el=>{
    if(!el) return;
    el.addEventListener('input', e=>{ e.target.value = (e.target.value || "").replace(/[^\d\.,-]/g,''); calculerMMP(); });
    el.addEventListener('focus', e=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    el.addEventListener('blur', e=>{ const n = parseNumberFromString(e.target.value); e.target.value = n ? n.toLocaleString('fr-FR', {minimumFractionDigits:0, maximumFractionDigits:0}) : ""; calculerMMP(); });
  });
}

function ajouterProduit(){
  const tbody = document.querySelector("#tableMMP tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `<td><input type="text" placeholder="Produit"></td><td><input type="number" class="qte" value="0"></td><td><input type="number" class="stock" value="0"></td><td><input type="text" class="achat" value="0"></td><td><input type="text" class="vente" value="0"></td><td class="montantAchat">0,00</td><td class="montantVente">0,00</td><td class="montantStock">0,00</td>`;
  tbody.appendChild(tr);
  bindMMPRow(tr);
  calculerMMP();
}

function calculerMMP() {
  let totalAchat = 0, totalVente = 0, totalStock = 0;
  document.querySelectorAll("#tableMMP tbody tr").forEach(tr => {
    const qte = parseFloat(tr.querySelector(".qte")?.value) || 0;
    const stock = parseFloat(tr.querySelector(".stock")?.value) || 0;
    const prixAchat = parseNumberFromString(tr.querySelector(".achat")?.value) || 0;
    const prixVente = parseNumberFromString(tr.querySelector(".vente")?.value) || 0;
    const montantAchat = qte * prixAchat;
    const montantVente = qte * prixVente;
    const montantStock = stock * prixAchat;
    tr.querySelector(".montantAchat").textContent = formatNombre(montantAchat);
    tr.querySelector(".montantVente").textContent = formatNombre(montantVente);
    tr.querySelector(".montantStock").textContent = formatNombre(montantStock);
    totalAchat += montantAchat;
    totalVente += montantVente;
    totalStock += montantStock;
  });
  document.getElementById("totalAchat").textContent = formatNombre(totalAchat);
  document.getElementById("totalVente").textContent = formatNombre(totalVente);
  document.getElementById("totalStock").textContent = formatNombre(totalStock);
  const mmp = totalAchat > 0 ? ((totalVente - totalAchat) / totalAchat * 100) : 0;
  document.getElementById("mmp").textContent = formatNombre(mmp) + " %";
  majCAMVSelonMMP();
}

function switchActivite(num) {
  document.querySelectorAll('.activite-content').forEach(content => { content.classList.remove('active'); });
  document.querySelectorAll('.activite-tab').forEach(tab => { tab.classList.remove('active'); });
  const targetContent = document.getElementById('activite' + num + '-content');
  if (targetContent) { targetContent.classList.add('active'); }
  const tabs = document.querySelectorAll('.activite-tab');
  if (tabs[num - 1]) { tabs[num - 1].classList.add('active'); }
}

function formatFinancialField(input) {
  if (!input) return;
  let value = input.value.replace(/\D/g, '');
  const numValue = parseInt(value || 0);
  input.value = numValue.toLocaleString('fr-FR') + ' MGA';
}

const tableBody = document.querySelector('#table_garanties tbody');
const btnAjouter = document.getElementById('ajouter_garantie');
const totalGarantiesEl = document.getElementById('total_garanties');
const totalActifsEl = document.getElementById('total_actifs');

function formatNumber(value) {
  if (isNaN(value) || value === null) return '0';
  return Number(value).toLocaleString('fr-FR');
}

function parseFormattedNumber(formattedValue) {
  if (!formattedValue) return 0;
  return parseFloat(formattedValue.toString().replace(/\s/g, '')) || 0;
}

function formatMGA(value) {
  if (!value) return '0 MGA';
  return formatNumber(value) + ' MGA';
}

function formatInput(input) {
  const cursorPosition = input.selectionStart;
  const originalValue = input.value;
  const numericValue = parseFormattedNumber(originalValue);
  if (!isNaN(numericValue)) {
    input.value = formatNumber(numericValue);
    const diff = input.value.length - originalValue.length;
    const newPosition = Math.max(0, cursorPosition + diff);
    input.setSelectionRange(newPosition, newPosition);
  }
}

function recalculerTotaux() {
  let totalGaranties = 0;
  let totalActifs = 0;
  if (tableBody) {
    tableBody.querySelectorAll('tr').forEach(tr => {
      const valAchatInput = tr.querySelector('.valeur-achat');
      const valEstimeeInput = tr.querySelector('.valeur-estimee');
      const valAchat = parseFormattedNumber(valAchatInput.value);
      const valEstimee = parseFormattedNumber(valEstimeeInput.value);
      const emplacement = tr.querySelector('.emplacement-select').value;
      const garantie = tr.querySelector('.garantie-select').value;
      const actif = tr.querySelector('.actif-select').value;
      const decote = valAchat ? (valEstimee / valAchat * 100) : 0;
      tr.querySelector('.decote').value = decote.toFixed(2);
      if (garantie === 'Oui') { totalGaranties += valEstimee; }
      if (actif === 'Oui' && emplacement === 'D') { totalActifs += valAchat; }
    });
  }
  if (totalGarantiesEl) totalGarantiesEl.textContent = formatMGA(totalGaranties);
  if (totalActifsEl) totalActifsEl.textContent = formatMGA(totalActifs);
  calculerCouvertureGaranties();
}

function ajouterGarantie() {
  if (!tableBody) return;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><select class="designation-select"><option value="">-- Sélectionner --</option><option value="Véhicule">Véhicule</option><option value="Immobilier">Immobilier</option><option value="Mobilier">Mobilier</option><option value="Terrain nu">Terrain nu</option><option value="Terrain bâti">Terrain bâti</option></select></td><td><select class="emplacement-select"><option value="D">D</option><option value="CS">CS</option></select></td><td><input type="text" placeholder="Description"></td><td><input type="text" placeholder="Marque"></td><td><input type="text" placeholder="Immat°…"></td><td><select class="garantie-select"><option value="Oui">Oui</option><option value="Non">Non</option></select></td><td><input type="text" class="valeur-achat currency-input" placeholder="Valeur d'achat" value="0"></td><td><input type="text" class="valeur-estimee currency-input" placeholder="Valeur estimée" value="0"></td><td><input type="number" class="decote" placeholder="Décote %" style="text-align:right; background-color:#007BFF; color:white; font-weight:bold;" readonly></td><td><select class="actif-select"><option value="Oui">Oui</option><option value="Non">Non</option></select></td><td><button type="button" class="btn-supprimer">X</button></td>`;
  const valAchatInput = tr.querySelector('.valeur-achat');
  const valEstimeeInput = tr.querySelector('.valeur-estimee');
  valAchatInput.value = formatNumber(parseFormattedNumber(valAchatInput.value));
  valEstimeeInput.value = formatNumber(parseFormattedNumber(valEstimeeInput.value));
  [valAchatInput, valEstimeeInput].forEach(input => {
    input.addEventListener('input', function () { formatInput(this); recalculerTotaux(); });
    input.addEventListener('blur', function () { formatInput(this); recalculerTotaux(); });
  });
  tr.querySelector('.btn-supprimer').addEventListener('click', () => { tr.remove(); recalculerTotaux(); });
  tr.querySelectorAll('select').forEach(el => { el.addEventListener('change', recalculerTotaux); });
  tableBody.appendChild(tr);
  recalculerTotaux();
}

function formatDF(value) {
  if (!value) return '';
  value = value.toString().replace(/\s|MGA/g, '').replace(',', '.');
  let num = parseFloat(value);
  if (isNaN(num)) return '';
  return num.toLocaleString('fr-FR', {maximumFractionDigits: 2});
}

function updateTotalDF() {
  const inputs = document.querySelectorAll('.df-input');
  let total = 0;
  inputs.forEach(input => {
    let val = parseFloat(input.value.replace(/\s|MGA/g, '').replace(',', '.'));
    if (!isNaN(val)) total += val;
  });
  const totalEl = document.getElementById('df-total');
  if (totalEl) { totalEl.textContent = total.toLocaleString('fr-FR') + ' MGA'; }
}

function formatMGATransport(value) { return value.toLocaleString("fr-FR", {minimumFractionDigits: 0}) + " MGA"; }

function calc() {
  let places_nat = +removeThousandsSeparator(document.querySelector('[name="places_nat"]')?.value || '0');
  let frais_nat = +removeThousandsSeparator(document.querySelector('[name="frais_nat"]')?.value || '0');
  let voyages_nat = +removeThousandsSeparator(document.querySelector('[name="voyages_nat"]')?.value || '0');
  let conso_nat = +removeThousandsSeparator(document.querySelector('[name="conso_nat"]')?.value || '0');
  let km_nat = +removeThousandsSeparator(document.querySelector('[name="km_nat"]')?.value || '0');
  let prix_nat = +removeThousandsSeparator(document.querySelector('[name="prix_nat"]')?.value || '0');
  let ca_nat = places_nat * frais_nat * voyages_nat;
  let carburant_nat = (conso_nat * km_nat / 100 * voyages_nat * prix_nat);
  const ca_nat_el = document.querySelector('[name="ca_nat"]');
  const carburant_nat_el = document.querySelector('[name="carburant_nat"]');
  if (ca_nat_el) ca_nat_el.value = formatMGATransport(ca_nat);
  if (carburant_nat_el) carburant_nat_el.value = formatMGATransport(carburant_nat);
  let frais_march = +removeThousandsSeparator(document.querySelector('[name="frais_march"]')?.value || '0');
  let charge_march = +removeThousandsSeparator(document.querySelector('[name="charge_march"]')?.value || '0');
  let voyages_march = +removeThousandsSeparator(document.querySelector('[name="voyages_march"]')?.value || '0');
  let km_march = +removeThousandsSeparator(document.querySelector('[name="km_march"]')?.value || '0');
  let conso_march = +removeThousandsSeparator(document.querySelector('[name="conso_march"]')?.value || '0');
  let prix_march = +removeThousandsSeparator(document.querySelector('[name="prix_march"]')?.value || '0');
  let ca_march = frais_march * charge_march * voyages_march;
  let carburant_march = (conso_march * km_march / 100 * voyages_march * prix_march);
  const ca_march_el = document.querySelector('[name="ca_march"]');
  const carburant_march_el = document.querySelector('[name="carburant_march"]');
  if (ca_march_el) ca_march_el.value = formatMGATransport(ca_march);
  if (carburant_march_el) carburant_march_el.value = formatMGATransport(carburant_march);
  let versement_bus = +removeThousandsSeparator(document.querySelector('[name="versement_bus"]')?.value || '0');
  let jours_bus = +removeThousandsSeparator(document.querySelector('[name="jours_bus"]')?.value || '0');
  let ca_bus = versement_bus * jours_bus;
  const ca_bus_el = document.querySelector('[name="ca_bus"]');
  if (ca_bus_el) ca_bus_el.value = formatMGATransport(ca_bus);
}

function formatNumberProd(num) {
  let parts = num.toString().split(".");
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  return parts.join(".");
}

function calculer() {
  const tbody = document.getElementById('tbody_matieres');
  if (!tbody) return;
  const rows = tbody.querySelectorAll('tr');
  const totals = [0, 0, 0, 0, 0];
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input[type="number"]');
    for (let p = 0; p < 5; p++) {
      const pu = parseFloat(inputs[p * 2]?.value) || 0;
      const qte = parseFloat(inputs[p * 2 + 1]?.value) || 0;
      totals[p] += pu * qte;
    }
  });
  for (let i = 0; i < 5; i++) {
    const qte = parseFloat(document.getElementById('qte' + (i + 1))?.value) || 0;
    const coutEl = document.getElementById('cout' + (i + 1));
    const unitEl = document.getElementById('unit' + (i + 1));
    if (coutEl) coutEl.textContent = formatNumberProd(Math.round(totals[i]));
    if (unitEl) unitEl.textContent = qte > 0 ? formatNumberProd(Math.round(totals[i] / qte)) : '0';
  }
}

function ajouterMat() {
  const tbody = document.getElementById('tbody_matieres');
  if (!tbody) return;
  const newRow = document.createElement('tr');
  let html = '<td><input type="text" placeholder="Nom matière"></td>';
  for (let i = 0; i < 5; i++) {
    html += `<td><input type="number" oninput="calculer()"></td><td><input type="number" oninput="calculer()"></td>`;
  }
  newRow.innerHTML = html;
  tbody.appendChild(newRow);
}

function toggleSection() {
  const content = document.getElementById("content_cout_prod");
  const btn = document.querySelector("#cout_prod .toggle-btn");
  if (content.style.display === "none") {
    content.style.display = "block";
    btn.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer';
  } else {
    content.style.display = "none";
    btn.innerHTML = '<i class="fas fa-eye"></i> Afficher';
  }
}

function toggleDepenses() {
  const wrapper = document.getElementById("df-wrapper");
  const btn = document.querySelector("#depenses_familiales button");
  if (!wrapper || !btn) return;
  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    btn.textContent = "Masquer";
  } else {
    wrapper.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function toggleActifs() {
  const wrapper = document.getElementById("actifs-wrapper");
  const btn = document.querySelector("#legend_actifs_immo button");
  if (!wrapper || !btn) return;
  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    btn.textContent = "Masquer";
  } else {
    wrapper.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function toggleMMP() {
  const wrapper = document.getElementById("mmp-wrapper");
  const btn = document.querySelector("#legend_mmp button");
  if (!wrapper || !btn) return;
  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    btn.textContent = "Masquer";
  } else {
    wrapper.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function togglePropo() {
  const wrapper = document.getElementById("propo-wrapper");
  const btn = document.querySelector("#legend_propo button");
  if (!wrapper || !btn) return;
  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    btn.textContent = "Masquer";
  } else {
    wrapper.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function toggleRatios() {
  const wrapper = document.getElementById("ratios-wrapper");
  const btn = document.querySelector("#legend_ratios button");
  if (!wrapper || !btn) return;
  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    btn.textContent = "Masquer";
  } else {
    wrapper.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function toggleCroisement() {
  const fs = document.querySelector("#croisement_specifique").parentNode;
  if (!fs) return;
  const table = fs.querySelector("table");
  const btn = fs.querySelector("button");
  if (!table || !btn) return;
  if (table.style.display === "none") {
    table.style.display = "table";
    btn.textContent = "Masquer";
  } else {
    table.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function toggleFonctionnement() {
  const wrapper = document.getElementById("activite-wrapper");
  const btn = document.getElementById("btn_toggle_fonctionnement");
  const icon = btn.querySelector("i");
  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    btn.setAttribute("aria-expanded", "true");
    icon.classList.remove("fa-eye");
    icon.classList.add("fa-eye-slash");
    btn.childNodes[1].textContent = " Masquer";
  } else {
    wrapper.style.display = "none";
    btn.setAttribute("aria-expanded", "false");
    icon.classList.remove("fa-eye-slash");
    icon.classList.add("fa-eye");
    btn.childNodes[1].textContent = " Afficher";
  }
}

function toggleActiviteHistory() {
  const content = document.getElementById('hist_activite_content');
  const btn = document.getElementById('btn_toggle_activite');
  const icon = btn.querySelector('i');
  if (content.classList.contains('collapsed')) {
    content.classList.remove('collapsed');
    btn.setAttribute('aria-expanded', 'true');
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
    btn.childNodes[1].textContent = ' Masquer';
  } else {
    content.classList.add('collapsed');
    btn.setAttribute('aria-expanded', 'false');
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
    btn.childNodes[1].textContent = ' Afficher';
  }
}

function toggleGeneralInfo() {
  const content = document.getElementById('infos_generales_content');
  const toggleBtn = document.querySelector('#legend_infos_generales .toggle-btn');
  const icon = toggleBtn.querySelector('i');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer';
  } else {
    content.style.display = 'none';
    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Afficher';
  }
}

function toggleBilan() {
  const tbl = document.getElementById('content_bilan');
  const btn = document.querySelector('#legend_bilan .toggle-btn');
  const ic = btn?.querySelector('i');
  if (!tbl || !btn || !ic) return;
  if (tbl.style.display === 'none') {
    tbl.style.display = 'block';
    ic.className = 'fas fa-eye-slash';
    btn.lastChild.textContent = ' Masquer';
  } else {
    tbl.style.display = 'none';
    ic.className = 'fas fa-eye';
    btn.lastChild.textContent = ' Afficher';
  }
}

function toggleCashFlow() {
  const tbl = document.getElementById('content_cashflow');
  const btn = document.querySelector('#legend_cashflow .toggle-btn');
  const ic = btn?.querySelector('i');
  if (!tbl || !btn || !ic) return;
  if (tbl.style.display === 'none') {
    tbl.style.display = 'block';
    ic.className = 'fas fa-eye-slash';
    btn.lastChild.textContent = ' Masquer';
  } else {
    tbl.style.display = 'none';
    ic.className = 'fas fa-eye';
    btn.lastChild.textContent = ' Afficher';
  }
}

function majBilan(){
  const caisse    = parseNumberFromString(document.getElementById('Caisse')?.value||0);
  const mobil     = parseNumberFromString(document.getElementById('solde_mobile')?.value||0);
  const epargne   = parseNumberFromString(document.getElementById('solde_epargne')?.value||0);
  const creance1  = parseNumberFromString(document.getElementById('creances_actuelles')?.value||0);
  const creance2  = parseNumberFromString(document.getElementById('creances_actuelles2')?.value||0);
  const stock     = parseNumberFromString(document.getElementById('totalStock')?.textContent||0);
  const actifImmo = parseNumberFromString(document.getElementById('total_actifs')?.textContent||0);
  document.getElementById('bilan_caisse').value            = fmtMGA(caisse);
  document.getElementById('bilan_treso_hors_act').value    = fmtMGA(mobil+epargne);
  document.getElementById('bilan_creances').value          = fmtMGA(creance1+creance2);
  document.getElementById('bilan_stock').value             = fmtMGA(stock);
  document.getElementById('bilan_actif_immo').value        = fmtMGA(actifImmo);
  const totalActif = caisse+mobil+epargne+creance1+creance2+stock+actifImmo;
  document.getElementById('bilan_total_actif').value       = fmtMGA(totalActif);
  const dettesF1 = parseNumberFromString(document.getElementById('dettes_fournisseurs')?.value||0);
  const dettesF2 = parseNumberFromString(document.getElementById('dettes_fournisseurs2')?.value||0);
  const encours  = parseNumberFromString(document.getElementById('encours_credit')?.value||0);
  const dettesLT = parseNumberFromString(document.getElementById('bilan_dettes_lt')?.value||0);
  document.getElementById('bilan_dettes_fourn').value = fmtMGA(dettesF1+dettesF2);
  document.getElementById('bilan_encours').value      = fmtMGA(encours);
  const fondsPropres = totalActif - (dettesF1+dettesF2+encours+dettesLT);
  document.getElementById('bilan_fonds_propres').value= fmtMGA(fondsPropres);
  const totalPassif = dettesF1+dettesF2+encours+dettesLT+fondsPropres;
  document.getElementById('bilan_total_passif').value = fmtMGA(totalPassif);
  let sumActAvant = 0, sumPasAvant = 0;
  document.querySelectorAll('#table_bilan .credit-avant-actif').forEach((inp,i)=>{sumActAvant+=parseNumberFromString(inp.value||0);});
  document.querySelectorAll('#table_bilan .credit-avant-passif').forEach((inp,i)=>{sumPasAvant+=parseNumberFromString(inp.value||0);});
  document.getElementById('bilan_total_actif_avant').value  = fmtMGA(sumActAvant);
  document.getElementById('bilan_total_passif_avant').value = fmtMGA(sumPasAvant);
  calculerRatios();
}

function calculerCashFlow() {
  const getVal = id => {
    let el = document.getElementById(id);
    if (!el) return 0;
    let val = (el.tagName === "SPAN") ? el.textContent : el.value;
    if (!val) return 0;
    return parseFloat(val.replace(/[^\d.-]/g, '').replace(',', '.')) || 0;
  };
  const setVal = (id, val) => {
    let el = document.getElementById(id);
    if (!el) return;
    let formatted = val.toLocaleString("fr-FR") + " MGA";
    if (el.tagName === "SPAN") {
      el.textContent = formatted;
    } else {
      el.value = formatted;
    }
  };
  let CA_activite1 = getVal("ca_ligne1"); 
  let CA_activite2 = getVal("ca_ligne2");
  let CA_mensuel  = CA_activite1 + CA_activite2;
  let CAMV_activite1 = getVal("camv_final");
  let CAMV_activite2 = getVal("camv_final2");
  let CAMV_mensuel   = CAMV_activite1 + CAMV_activite2;
  let Cash_flow_brut = CA_mensuel - CAMV_mensuel;
  let Total_opex1 = getVal("opex-total");
  let Total_opex2 = getVal("opex-total2");
  let Total_opex  = Total_opex1 + Total_opex2;
  let Cash_flow_net = Cash_flow_brut - Total_opex;
  let echeances = getVal("echeances"); 
  let revenus_mensuels_caution = getVal("revenus_mensuels_caution");
  let lien_demandeur = document.getElementById("lien_demandeur")?.value || "";
  let Salaire = getVal("Salaire");
  let Autres_revenus = Salaire + ((lien_demandeur === "Epoux(se)" || lien_demandeur === "Concubin(e)") ? revenus_mensuels_caution : 0);
  let Depenses_familiales = getVal("df-total");
  let Cash_flow = Cash_flow_net - echeances + Autres_revenus - Depenses_familiales;
  let DSCR = Cash_flow * 0.5;
  setVal("CA_activité1", CA_activite1);
  setVal("CA_activité2", CA_activite2);
  setVal("CA_mensuel", CA_mensuel);
  setVal("CAMV_activité1", CAMV_activite1);
  setVal("CAMV_activité2", CAMV_activite2);
  setVal("CAMV_mensuel", CAMV_mensuel);
  setVal("Cash_flow_brut", Cash_flow_brut);
  setVal("Total_opex1", Total_opex1);
  setVal("Total_opex2", Total_opex2);
  setVal("Total_opex", Total_opex);
  setVal("Cash_flow_net", Cash_flow_net);
  setVal("echeances_credit", echeances);
  setVal("Autres_revenus", Autres_revenus);
  setVal("Depenses_familiales", Depenses_familiales);
  setVal("Cash_flow", Cash_flow);
  setVal("DSCR", DSCR);
  calculerRatios();
}

function calculMensualite(montant, duree, tauxAnnuel = 0.39) {
  if (!montant || !duree || duree <= 0) return 0;
  let i = tauxAnnuel / 12;
  return montant * i / (1 - Math.pow(1 + i, -duree));
}

function majMensualites() {
  let montant_ac = parseFloat(document.querySelector('[name="montant_ac"]').value.replace(/\s/g, '')) || 0;
  let duree_ac   = parseInt(document.querySelector('[name="duree_ac"]').value) || 0;
  let montant_comite = parseFloat(document.querySelector('[name="montant_comite"]').value.replace(/\s/g, '')) || 0;
  let duree_comite   = parseInt(document.querySelector('[name="duree_comite"]').value) || 0;
  let mensu_ac = calculMensualite(montant_ac, duree_ac);
  let mensu_comite = calculMensualite(montant_comite, duree_comite);
  document.getElementById("mensualite_ac").value = mensu_ac ? mensu_ac.toLocaleString("fr-FR", {minimumFractionDigits:0, maximumFractionDigits:0}) + " MGA" : "";
  document.getElementById("mensualite_comite").value = mensu_comite ? mensu_comite.toLocaleString("fr-FR", {minimumFractionDigits:0, maximumFractionDigits:0}) + " MGA" : "";
  controleMensualite();
  syncMensualite();
  calculerCouvertureGaranties();
  calculerRatios();
}

function syncMensualite() {
  let comite = document.getElementById("mensualite_comite").value;
  if (comite && comite.trim() !== "") {
    document.getElementById("mensualite_proposee").value = comite;
  }
}

function calculerCouvertureGaranties() {
  let totalGaranties = parseFloat(document.getElementById("total_garanties").textContent.replace(/\s|MGA/g, '')) || 0;
  let montantComite = parseFloat(document.querySelector('[name="montant_comite"]').value.replace(/\s/g, '')) || 0;
  let couverture = montantComite > 0 ? (totalGaranties / montantComite) * 100 : 0;
  let couvertureEl = document.getElementById("couverture_garanties");
  if (couvertureEl) {
    couvertureEl.value = couverture.toFixed(2) + " %";
    if (couverture < 125) {
      couvertureEl.classList.add('ratio-red');
      couvertureEl.classList.remove('ratio-green');
    } else {
      couvertureEl.classList.add('ratio-green');
      couvertureEl.classList.remove('ratio-red');
    }
  }
}

function calculerRatios() {
  const bilan_fonds_propres = parseNumberFromString(document.getElementById('bilan_fonds_propres')?.value || 0);
  const bilan_caisse = parseNumberFromString(document.getElementById('bilan_caisse')?.value || 0);
  const bilan_creances = parseNumberFromString(document.getElementById('bilan_creances')?.value || 0);
  const bilan_stock = parseNumberFromString(document.getElementById('bilan_stock')?.value || 0);
  const montant_comite = parseFloat(document.querySelector('[name="montant_comite"]')?.value.replace(/\s/g, '') || 0);
  const bilan_treso_hors_act = parseNumberFromString(document.getElementById('bilan_treso_hors_act')?.value || 0);
  const bilan_dettes_fourn = parseNumberFromString(document.getElementById('bilan_dettes_fourn')?.value || 0);
  const bilan_encours = parseNumberFromString(document.getElementById('bilan_encours')?.value || 0);
  const bilan_dettes_lt = parseNumberFromString(document.getElementById('bilan_dettes_lt')?.value || 0);
  const mensualite_comite = parseNumberFromString(document.getElementById('mensualite_comite')?.value || 0);
  const cash_flow = parseNumberFromString(document.getElementById('Cash_flow')?.value || 0);
  const CA_mensuel = parseNumberFromString(document.getElementById('CA_mensuel')?.value || 0);

  const ratio_stock = (bilan_caisse + bilan_creances + bilan_stock) !== 0 
    ? CA_mensuel / (bilan_caisse + bilan_creances + bilan_stock) 
    : 0;
  const ratioStockEl = document.getElementById('ratio_stock');
  if (ratioStockEl) {
    ratioStockEl.value = ratio_stock.toFixed(2).replace('.', ',');
  }

  const ratio_solvabilite = (bilan_caisse + bilan_creances + bilan_stock + montant_comite) !== 0 
    ? bilan_fonds_propres / (bilan_caisse + bilan_creances + bilan_stock + montant_comite) 
    : 0;
  const ratioSolvEl = document.getElementById('ratio_solvabilite');
  if (ratioSolvEl) {
    ratioSolvEl.value = ratio_solvabilite.toFixed(2).replace('.', ',');
    if (ratio_solvabilite < 1) {
      ratioSolvEl.classList.add('ratio-red');
      ratioSolvEl.classList.remove('ratio-green');
    } else {
      ratioSolvEl.classList.add('ratio-green');
      ratioSolvEl.classList.remove('ratio-red');
    }
  }

  const ratio_endettement = bilan_fonds_propres !== 0 
    ? (montant_comite + bilan_caisse + bilan_creances + bilan_stock) / bilan_fonds_propres 
    : 0;
  const ratioEndEl = document.getElementById('ratio_endettement');
  if (ratioEndEl) {
    ratioEndEl.value = ratio_endettement.toFixed(2).replace('.', ',');
    if (ratio_endettement > 1) {
      ratioEndEl.classList.add('ratio-red');
      ratioEndEl.classList.remove('ratio-green');
    } else {
      ratioEndEl.classList.add('ratio-green');
      ratioEndEl.classList.remove('ratio-red');
    }
  }

  const dscr = cash_flow !== 0 ? (mensualite_comite / cash_flow) * 100 : 0;
  const dscrEl = document.getElementById('dscr');
  if (dscrEl) {
    dscrEl.value = dscr.toFixed(2).replace('.', ',') + " %";
    if (dscr > 50) {
      dscrEl.classList.add('ratio-red');
      dscrEl.classList.remove('ratio-green');
    } else {
      dscrEl.classList.add('ratio-green');
      dscrEl.classList.remove('ratio-red');
    }
  }

  const ratio_liquidite = (bilan_dettes_fourn + bilan_encours + bilan_dettes_lt) !== 0 
    ? (bilan_caisse + bilan_treso_hors_act + bilan_creances + bilan_stock) / (bilan_dettes_fourn + bilan_encours + bilan_dettes_lt) 
    : 0;
  const ratioLiqEl = document.getElementById('ratio_liquidite');
  if (ratioLiqEl) {
    ratioLiqEl.value = ratio_liquidite.toFixed(2).replace('.', ',');
    if (ratio_liquidite < 1.5) {
      ratioLiqEl.classList.add('ratio-red');
      ratioLiqEl.classList.remove('ratio-green');
    } else {
      ratioLiqEl.classList.add('ratio-green');
      ratioLiqEl.classList.remove('ratio-red');
    }
  }
}

function exportToExcel() {
  var table = document.getElementById("table_garanties").cloneNode(true);
  var inputs = table.querySelectorAll("input, select, textarea");
  inputs.forEach(el => {
    var td = el.parentNode;
    var value = el.value || "";
    td.textContent = value;
  });
  var workbook = XLSX.utils.table_to_book(table, { sheet: "Garanties" });
  XLSX.writeFile(workbook, "garanties.xlsx");
}

function rawNumber(selector) {
  const el = typeof selector === 'string' ? document.getElementById(selector) : selector;
  if (!el) return 0;
  return parseInt((el.value || el.textContent || '').replace(/\D/g, ''), 10) || 0;
}

function controleMensualite() {
  const mensEl = document.getElementById('mensualite_comite');
  const capEl  = document.getElementById('capacite_paiement');
  if (!mensEl || !capEl) return;

  const mens = rawNumber(mensEl);
  const cap  = rawNumber(capEl);

  [mensEl, capEl].forEach(el => {
    el.style.backgroundColor = '';
    el.style.color = '';
  });

  if (mens > cap && cap > 0) {
    mensEl.style.backgroundColor = 'red';
    mensEl.style.color = 'white';
    capEl.style.backgroundColor  = 'red';
    capEl.style.color  = 'white';
    if (!window.alreadyShown) {
      alert('⚠️ La mensualité comité dépasse la capacité de paiement !');
      window.alreadyShown = true;
      setTimeout(() => window.alreadyShown = false, 2000);
    }
  }
}

function toggleReferences() {
  const wrapper = document.getElementById("references-wrapper");
  const btn = document.getElementById("btnToggleReferences");
  if (wrapper.style.display === "none" || wrapper.style.display === "") {
    wrapper.style.display = "block";
    btn.textContent = "Masquer";
  } else {
    wrapper.style.display = "none";
    btn.textContent = "Afficher";
  }
}

function ajouterLigneReference() {
  const tbody = document.querySelector('#table_references tbody');
  const ligneCount = tbody.rows.length + 1;
  const tr = document.createElement('tr');

  tr.innerHTML = `
    <td>${ligneCount}</td>
    <td><input type="text" name="nom_reference[]" style="width:95%;" required></td>
    <td>
      <select name="relation_reference[]" style="width:95%;" required>
        <option value="">-- Sélectionner --</option>
        <option value="Ami">Ami(e)</option>
        <option value="Famille">Famille</option>
        <option value="Époux(se)">Époux(se)</option>
        <option value="Frère">Frère</option>
        <option value="Sœur">Sœur</option>
        <option value="Parent">Parent</option>
        <option value="Fils">Fils</option>
        <option value="Fille">Fille</option>
        <option value="Autres">Autres</option>
      </select>
    </td>
    <td>
      <input type="text" name="contact_reference[]" required
             placeholder="xxx xx xxx xx" style="width:95%; text-align:center;"
             oninput="maskContact(this)" onkeydown="onlyDigits(event)">
    </td>
    <td><input type="text" name="adresse_reference[]" style="width:95%;" required></td>
    <td><button type="button" onclick="supprimerLigneRef(this)">🗑</button></td>
  `;
  tbody.appendChild(tr);
  renumeroterReferences();
}

function supprimerLigneRef(btn) {
  const tr = btn.closest('tr');
  tr.remove();
  renumeroterReferences();
}

function renumeroterReferences() {
  document.querySelectorAll('#table_references tbody tr').forEach((tr, i) => {
    tr.querySelector('td:first-child').textContent = i + 1;
  });
}

function maskContact(input) {
  let digits = input.value.replace(/\D/g, '');
  digits = digits.substring(0, 10);
  let formatted = '';
  if (digits.length <= 3) {
    formatted = digits;
  } else if (digits.length <= 5) {
    formatted = digits.substring(0, 3) + ' ' + digits.substring(3);
  } else if (digits.length <= 8) {
    formatted = digits.substring(0, 3) + ' ' + digits.substring(3, 5) + ' ' + digits.substring(5);
  } else {
    formatted = digits.substring(0, 3) + ' ' + digits.substring(3, 5) + ' ' + digits.substring(5, 8) + ' ' + digits.substring(8);
  }
  input.value = formatted;
}

function onlyDigits(event) {
  if (event.ctrlKey || event.metaKey || event.key === 'Backspace' || event.key === 'Tab' || event.key.startsWith('Arrow')) return;
  if (!/[0-9]/.test(event.key)) event.preventDefault();
}

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = (textarea.scrollHeight) + 'px';
}

function ajouterLigneRisque() {
  const table = document.getElementById('table_risques').getElementsByTagName('tbody')[0];
  const newRow = table.insertRow();

  const cell1 = newRow.insertCell(0);
  const textareaRisque = document.createElement('textarea');
  textareaRisque.name = 'risque[]';
  textareaRisque.style.width = '95%';
  textareaRisque.style.resize = 'none';
  textareaRisque.style.overflow = 'hidden';
  textareaRisque.required = true;
  textareaRisque.addEventListener('input', () => autoResize(textareaRisque));
  cell1.appendChild(textareaRisque);
  autoResize(textareaRisque);

  const cell2 = newRow.insertCell(1);
  const selectNiveau = document.createElement('select');
  selectNiveau.name = 'niveau_risque[]';
  selectNiveau.style.width = '95%';
  selectNiveau.required = true;
  ["", "Faible", "Moyen", "Élevé"].forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.text = opt === "" ? "-- Sélectionner --" : opt;
    selectNiveau.appendChild(option);
  });
  cell2.appendChild(selectNiveau);

  const cell3 = newRow.insertCell(2);
  const textareaMitigation = document.createElement('textarea');
  textareaMitigation.name = 'mitigation[]';
  textareaMitigation.style.width = '95%';
  textareaMitigation.style.resize = 'none';
  textareaMitigation.style.overflow = 'hidden';
  textareaMitigation.required = true;
  textareaMitigation.addEventListener('input', () => autoResize(textareaMitigation));
  cell3.appendChild(textareaMitigation);
  autoResize(textareaMitigation);

  const cell4 = newRow.insertCell(3);
  const btnSuppr = document.createElement('button');
  btnSuppr.type = 'button';
  btnSuppr.textContent = '🗑';
  btnSuppr.onclick = function() { supprimerLigneRisque(this); };
  cell4.appendChild(btnSuppr);
}

function supprimerLigneRisque(btn) {
  const row = btn.parentNode.parentNode;
  row.parentNode.removeChild(row);
}

function toggleRisques() {
  const wrapper = document.getElementById('risques-wrapper');
  const btn = document.getElementById('btnToggleRisques');
  if (wrapper.style.display === 'none') {
    wrapper.style.display = 'block';
    btn.textContent = 'Masquer';
  } else {
    wrapper.style.display = 'none';
    btn.textContent = 'Afficher';
  }
}

function togglePoints() {
  const wrapper = document.getElementById('point-wrapper');
  const btn = document.getElementById('btnTogglePoints');
  if (wrapper.style.display === 'none') {
    wrapper.style.display = 'block';
    btn.textContent = 'Masquer';
  } else {
    wrapper.style.display = 'none';
    btn.textContent = 'Afficher';
  }
}

function formatAsXXX_XX_XXX_XX(value) {
  const digits = value.replace(/\D/g, '').slice(0, 10);
  const g1 = digits.slice(0, 3);
  const g2 = digits.slice(3, 5);
  const g3 = digits.slice(5, 8);
  const g4 = digits.slice(8, 10);
  return [g1, g2, g3, g4].filter(Boolean).join(' ');
}

function applyPhoneFormat(id) {
  const input = document.getElementById(id);
  if (!input) return;

  input.addEventListener('input', () => {
    input.value = formatAsXXX_XX_XXX_XX(input.value);
  });

  input.addEventListener('keydown', (e) => {
    const allowed = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'];
    if (allowed.includes(e.key)) return;
    if (!/^[0-9]$/.test(e.key)) e.preventDefault();
  });

  input.addEventListener('paste', (e) => {
    e.preventDefault();
    const pasted = (e.clipboardData || window.clipboardData).getData('text');
    const digits = pasted.replace(/\D/g, '').slice(0, 10);
    input.value = formatAsXXX_XX_XXX_XX(digits);
  });
}

function copierEtSauvegarder() {
  const total = parseFloat(document.getElementById('total_objet')?.value || '0');
  if (total > 2575000) { alert("⚠️ Le total ne peut pas dépasser 2 575 000 !"); return; }

  const nomPrenom = (document.getElementById('nom_prenom_client')?.value || 'Demandeur').replace(/[^a-zA-Z0-9]/g,'_');
  const now = new Date();
  const pad = n => ('0'+n).slice(-2);
  const fileName = `${nomPrenom}_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.html`;

  // Cloner le body
  const cloneBody = document.body.cloneNode(true);

  // Rendre tous les inputs, textarea et selects readonly au départ
  cloneBody.querySelectorAll('input, textarea, select').forEach(el => {
    el.setAttribute('data-original-readonly', 'true');
    el.setAttribute('readonly', 'readonly');
    if(el.tagName === 'SELECT') {
      el.disabled = true;
    }
  });

  // Ajouter le script de déverrouillage + sauvegarde
  const script = document.createElement('script');
  script.textContent = `
    document.addEventListener('DOMContentLoaded', () => {
      const creerOverlay = () => {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;';
        const container = document.createElement('div');
        container.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;text-align:center;';
        container.innerHTML = \`
          <h2>🔒 Fichier verrouillé</h2>
          <p>Entrez le mot de passe :</p>
          <input type="password" id="pwdInput" style="padding:10px;width:200px;"><br><br>
          <button id="btnUnlock">Déverrouiller</button>
        \`;
        overlay.appendChild(container);
        document.body.appendChild(overlay);

        document.getElementById('btnUnlock').addEventListener('click', () => {
          const pwd = document.getElementById('pwdInput').value;
          if(pwd === '2110'){
            document.querySelectorAll('input, textarea, select').forEach(el => {
              el.removeAttribute('readonly');
              if(el.tagName === 'SELECT') el.disabled = false;
            });
            overlay.remove();
            alert('✅ Fichier déverrouillé !');
          } else {
            alert('❌ Mot de passe incorrect');
          }
        });
      };

      creerOverlay();

      // Bouton sauvegarder pour figer définitivement
      const btnSave = document.createElement('button');
      btnSave.textContent = 'Sauvegarder';
      btnSave.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:8px;cursor:pointer;';
      document.body.appendChild(btnSave);

      btnSave.addEventListener('click', () => {
        document.querySelectorAll('input, textarea, select').forEach(el => {
          el.setAttribute('readonly', 'readonly');
          if(el.tagName === 'SELECT') el.disabled = true;
        });
        alert('✅ Fichier figé !');
      });
    });
  `;
  cloneBody.appendChild(script);

  const htmlContent = `<!DOCTYPE html>\n<html lang="fr">\n${document.head.outerHTML}\n<body>\n${cloneBody.innerHTML}\n</body>\n</html>`;
  const blob = new Blob([htmlContent], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();

  alert('✅ Fichier sauvegardé avec succès !');
}



function genererSynthesePDF() {
  if (!window.jspdf) {
    alert("⚠️ jsPDF n'est pas chargé !");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

  const marg = 40;
  let y = 60;
  const pageHeight = doc.internal.pageSize.height;

  // --- UTILITAIRES ---
  const val = (id) => {
    const el = document.getElementById(id);
    if (!el) return '';
    let v = el.value || el.textContent || '';
    v = v.replace(/MGA|Ar/gi, '').replace(/\//g, '').replace(/\s+/g, ' ').trim();
    return v;
  };

  const checkPage = (space = 40) => {
    if (y + space > pageHeight - 50) {
      doc.addPage();
      y = 50;
    }
  };

  const addSection = (title, size = 12) => {
    checkPage(30);
    doc.setFontSize(size);
    doc.setFont('helvetica', 'bold');
    doc.text(title, marg, y);
    y += size === 14 ? 20 : 18;
    doc.setFont('helvetica', 'normal');
  };

  const addText = (text, indent = 0) => {
    if (!text) return;
    checkPage();
    const cleanText = text.replace(/\s+/g, ' ').trim();
    doc.setFontSize(10);

    // ✅ Retour automatique à la ligne
    const lines = doc.splitTextToSize(cleanText, 500);
    lines.forEach(line => {
      doc.text(line, marg + indent, y);
      y += 13;
      checkPage();
    });
  };

  const formatDateFR = (dateStr) => {
    if (!dateStr) return '';
    const clean = dateStr.replace(/\D/g,'');
    if (clean.length===8 && dateStr.includes('-')) {
      const [yyyy, mm, dd] = dateStr.split('-');
      return `${dd}/${mm}/${yyyy}`;
    }
    return dateStr;
  };

  const formatHeureFR = (heureStr) => {
    if(!heureStr) return '';
    const digits = heureStr.replace(/\D/g,'');
    if(digits.length===4) return `${digits.slice(0,2)}:${digits.slice(2)}`;
    if(digits.length===3) return `0${digits[0]}:${digits.slice(1)}`;
    if(digits.length===2) return `${digits.padStart(2,'0')}:00`;
    if(digits.length===1) return `0${digits}:00`;
    return '';
  };

  // ✅ Téléphone format "032 24 193 56"
  const formatPhone = (num) => {
    if(!num) return '';
    const digits = num.replace(/\D/g,'');
    if (digits.length === 9) return `0${digits.slice(0,2)} ${digits.slice(2,4)} ${digits.slice(4,7)} ${digits.slice(7)}`;
    if (digits.length === 10) return `${digits.slice(0,3)} ${digits.slice(3,5)} ${digits.slice(5,8)} ${digits.slice(8)}`;
    return num;
  };

  const formatRatio = (valeur, pourcentage = false) => {
    if (!valeur) return '';
    const num = parseFloat(valeur.replace(/\s/g,'').replace(',','.'));
    if (isNaN(num)) return valeur;
    if (pourcentage) return (num / 100).toFixed(2).replace('.', ',') + ' %';
    return (num / 100).toFixed(2).replace('.', ',');
  };

  // --- TITRE ---
  doc.setFontSize(16);
  doc.setFont('helvetica', 'bold');
  const idClient = val('id_client');
  const nomClient = val('nom_prenom_client');
  doc.text(`SYNTHESE DE CREDIT - ${idClient} - ${nomClient}`, marg, y);
  y += 25;
  doc.setFont('helvetica', 'normal');

  // --- EN-TÊTE ---
  const agence = document.querySelector('select')?.value || '';
  const acTraitant = document.querySelectorAll('input[type="text"]')[0]?.value || '';
  addText(`Agence : ${agence}`);
  addText(`AC traitant : ${acTraitant}`);
  addText(`Date de visite : ${formatDateFR(val('date_visite'))}     Heure : ${formatHeureFR(val('heure_visite'))}`);
  y += 10;

  // --- 1 ---
  addSection('1. INFORMATIONS SUR LA DEMANDE DE CREDIT', 14);
  addText(`Montant de la demande : ${val('montant_demande')} MGA`);
  addText(`Durée : ${document.querySelectorAll('input[type="number"]')[0]?.value || ''} mois`);
  addText(`Capacité de paiement : ${val('capacite_paiement')} MGA`);
  addText(`Date de remboursement demandée : ${formatDateFR(document.querySelectorAll('input[type="date"]')[1]?.value || '')}`);
  addText('Objet du crédit :');
  document.querySelectorAll('#tbody_objet tr').forEach(tr => {
    const lib = tr.querySelector('input[name="libelle[]"]')?.value || '';
    const mt = tr.querySelector('input[name="montant_objet[]"]')?.value || '';
    if (lib) addText(`  - ${lib} : ${mt}`, 10);
  });

  // --- 2 ---
  addSection('2. INFORMATIONS GENERALES', 14);
  addText('DEMANDEUR :');
  addText(`  ID client : ${val('id_client')}`, 5);
  addText(`  Nom : ${val('nom_prenom_client')}`, 5);
  addText(`  Téléphone : ${formatPhone(val('num_client'))}`, 5);
  addText(`  État civil : ${document.getElementById('etat_civil_client')?.value || ''}`, 5);
  addText(`  Personnes à charge : ${val('nb_client')}`, 5);

  addText('CAUTION :');
  addText(`  ID : ${val('id_caution')}`, 5);
  addText(`  Nom : ${val('nom_prenom_caution')}`, 5);
  addText(`  Téléphone : ${formatPhone(val('num_caution'))}`, 5);
  addText(`  Lien : ${document.getElementById('lien_demandeur')?.value || ''}`, 5);
  addText(`  Revenus mensuels : ${val('revenus_mensuels_caution')} MGA`, 5);

  // --- 3 ---
  addSection("3. HISTORIQUE DE L'ACTIVITE", 14);
  document.querySelectorAll('#tbody_activite tr').forEach((tr, i) => {
    const nom = tr.querySelector('select[name="nom_activite[]"]')?.value || '';
    if (!nom) return;
    const mrg = tr.querySelector('input[name="marge_activite[]"]')?.value || '';
    const anc = tr.querySelector('input[name="anciennete_activite[]"]')?.value || '';
    const sec = tr.querySelector('select[name="secteur_activite[]"]')?.value || '';
    addText(`  Activité ${i+1} : ${nom} | Marge: ${mrg} | Ancienneté: ${anc} ans | Secteur: ${sec}`, 5);
  });

  // --- 4 ---
  addSection('4. INFORMATIONS FINANCIERES', 14);
  ['Salaire','solde_mobile','solde_epargne','Caisse','echeances','encours_credit']
    .forEach(id => addText(`${id.replace(/_/g,' ')} : ${val(id)} MGA`));

  // --- 5 ---
  addSection("5. FONCTIONNEMENT DE L'ACTIVITE", 14);
  addText(`CA ligne 1 : ${val('ca_ligne1')}`);
  addText(`CAMV final : ${val('camv_final')}`);
  addText(`CA ligne 2 : ${val('ca_ligne2')}`);
  addText(`CAMV final 2 : ${val('camv_final2')}`);

  // --- 6 ---
  addSection('6. MARGE MOYENNE PONDEREE (MMP)', 14);
  addText(`MMP : ${val('mmp')} `);

  // --- 7 ---
  addSection('7. ACTIFS IMMOBILISES / GARANTIES', 14);
  addText(`Total garanties : ${val('total_garanties')}`);
  addText(`Total actifs : ${val('total_actifs')}`);

  // --- 8 ---
  addSection('8. DEPENSES FAMILIALES', 14);
  addText(`Total dépenses familiales : ${val('df-total')}`);

  // --- 9 ---
  addSection('9. BILAN', 14);
  addText(`Total Actif : ${val('bilan_total_actif')}`);
  addText(`Total Passif : ${val('bilan_total_passif')}`);

  // --- 10 ---
  addSection('10. CASH FLOW', 14);
  ['CA_mensuel','CAMV_mensuel','Cash_flow_brut','Cash_flow_net','Cash_flow','DSCR']
    .forEach(id => addText(`${id.replace(/_/g,' ')} : ${val(id)}`));

 // --- 11. RATIOS ---
addSection('11. RATIOS', 14);

// Affichage direct des valeurs du HTML
addText(`Ratio stock : ${val('ratio_stock')}`);
addText(`Ratio endettement : ${val('ratio_endettement')}`);
addText(`Ratio liquidité : ${val('ratio_liquidite')}`);
addText(`Ratio solvabilité : ${val('ratio_solvabilite')}`);

// Ajouter le % pour DSCR et Couverture garanties
const dscr = val('dscr').replace(/\s/g,'');
addText(`DSCR : ${dscr} `);

const couverture = val('couverture_garanties').replace(/\s/g,'');
addText(`Couverture garanties : ${couverture} `);


  // --- 12 ---
  addSection('12. PROPOSITION AC / DECISION COMITE', 14);
  const cleanMontant = m => {
    if (!m) return '';
    const num = m.replace(/[^\d]/g, '');
    return num ? parseInt(num,10).toLocaleString('fr-FR') : m;
  };
  addText(`Proposition AC : ${cleanMontant(document.querySelector('[name="montant_ac"]')?.value)} MGA / ${(document.querySelector('[name="duree_ac"]')?.value || '')} mois`);
  addText(`Mensualité AC : ${val('mensualite_ac')}`);
  addText(`Décision comité : ${cleanMontant(document.querySelector('[name="montant_comite"]')?.value)} MGA / ${(document.querySelector('[name="duree_comite"]')?.value || '')} mois`);
  addText(`Mensualité comité : ${val('mensualite_comite')}`);

  // --- 13 ---
  addSection('13. REFERENCES MORALES ET PROFESSIONNELLES', 14);
  document.querySelectorAll('#table_references tbody tr').forEach((tr, i) => {
    const nom = tr.querySelector('input[name="nom_reference[]"]')?.value || '';
    if (!nom) return;
    const rel = tr.querySelector('select[name="relation_reference[]"]')?.value || '';
    const contact = tr.querySelector('input[name="contact_reference[]"]')?.value || '';
    const adresse = tr.querySelector('input[name="adresse_reference[]"]')?.value || '';
    addText(`${i + 1}. ${nom} - ${rel} - ${contact || ''} - ${adresse || ''}`, 5);
  });

  // --- 14 ---
  addSection('14. RISQUES', 14);
  document.querySelectorAll('#table_risques tbody tr').forEach((tr,i) => {
    const risque = tr.querySelector('textarea[name="risque[]"]')?.value || '';
    if (!risque) return;
    const niveau = tr.querySelector('select[name="niveau_risque[]"]')?.value || '';
    const mitigation = tr.querySelector('textarea[name="mitigation[]"]')?.value || '';
    addText(`  Risque ${i+1} [${niveau}] : ${risque}`, 5);
    if (mitigation) addText(`  Mitigation : ${mitigation}`, 10);
  });

  // --- 15 ---
  addSection("15. POINTS D'ATTACHE", 14);
  const points = document.getElementById('pointsTextarea')?.value || '';
  points.split('\n').forEach(line => {
    if (line.trim()) addText(`  ${line.trim()}`, 5);
  });

  // --- FIN ---
  const safeName = (nomClient || 'Client').replace(/[^a-z0-9]/gi,'_');
  const filename = `Synthese_${safeName}_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(filename);
  alert('✅ PDF généré avec succès !');
}




document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.opex-input').forEach(input => {
    input.addEventListener('input', (e)=>{ e.target.value = (e.target.value || "").replace(/[^\d]/g,''); updateOpexTotal(); });
    input.addEventListener('focus', (e)=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    input.addEventListener('blur', (e)=>{ const n = parseNumberFromString(e.target.value); e.target.value = n>0 ? fmtMGA(n) : ""; updateOpexTotal(); });
  });
  document.querySelectorAll('.opex-input2').forEach(input => {
    input.addEventListener('input', (e)=>{ e.target.value = (e.target.value || "").replace(/[^\d]/g,''); updateOpexTotal2(); });
    input.addEventListener('focus', (e)=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    input.addEventListener('blur', (e)=>{ const n = parseNumberFromString(e.target.value); e.target.value = n>0 ? fmtMGA(n) : ""; updateOpexTotal2(); });
  });
  ['creances_actuelles','dettes_fournisseurs','achat_max','achat_min','capacite_paiement'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', (e)=>{ e.target.value = (e.target.value || "").replace(/[^\d]/g,''); });
    el.addEventListener('focus', (e)=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    el.addEventListener('blur', (e)=>{
      const n = parseNumberFromString(e.target.value);
      e.target.value = n>0 ? fmtMGA(n) : "";
      if(id === 'achat_max' || id === 'achat_min') majCAMVMensuel();
    });
  });
  ['creances_actuelles2','dettes_fournisseurs2','achat_max2','achat_min2'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', (e)=>{ e.target.value = (e.target.value || "").replace(/[^\d]/g,''); });
    el.addEventListener('focus', (e)=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    el.addEventListener('blur', (e)=>{
      const n = parseNumberFromString(e.target.value);
      e.target.value = n>0 ? fmtMGA(n) : "";
      if(id === 'achat_max2' || id === 'achat_min2') majCAMVMensuel2();
    });
  });
  ['vente_jour_v3','vente_jour_v2','vente_jour_v1','vente_registre_m3','vente_registre_m2','vente_registre_m1'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', (e)=>{ e.target.value = (e.target.value||"").replace(/[^\d]/g,''); });
    el.addEventListener('focus', (e)=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    el.addEventListener('blur', ()=>{ majVenteMensuelle(); majVenteMensRV(); });
  });
  ['vente_jour_v3_2','vente_jour_v2_2','vente_jour_v1_2','vente_registre_m3_2','vente_registre_m2_2','vente_registre_m1_2'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', (e)=>{ e.target.value = (e.target.value||"").replace(/[^\d]/g,''); });
    el.addEventListener('focus', (e)=>{ e.target.value = String(parseNumberFromString(e.target.value) || ""); });
    el.addEventListener('blur', ()=>{ majVenteMensuelle2(); majVenteMensRV2(); });
  });
  const freqVente = document.getElementById('frequence_vente');
  if (freqVente) freqVente.addEventListener('input', majVenteMensuelle);
  const freqAchat = document.getElementById('frequence_achat');
  if (freqAchat) freqAchat.addEventListener('input', majCAMVMensuel);
  const freqVente2 = document.getElementById('frequence_vente2');
  if (freqVente2) freqVente2.addEventListener('input', majVenteMensuelle2);
  const freqAchat2 = document.getElementById('frequence_achat2');
  if (freqAchat2) freqAchat2.addEventListener('input', majCAMVMensuel2);
  const lien = document.getElementById('lien_demandeur');
  if (lien) lien.addEventListener('change', synchroniserCaution);
  const etatCivilClient = document.getElementById('etat_civil_client');
  if (etatCivilClient) etatCivilClient.addEventListener('input', synchroniserCaution);
  const nbClient = document.getElementById('nb_client');
  if (nbClient) nbClient.addEventListener('input', synchroniserCaution);
  const adresseClient = document.getElementById('adresse_domicile_client');
  if (adresseClient) adresseClient.addEventListener('input', synchroniserCaution);
  document.querySelectorAll('#tableMMP tbody tr').forEach(bindMMPRow);
  document.querySelectorAll('.thousands-separator').forEach(input => {
    input.addEventListener('input', function() { formatThousands(this); });
    input.addEventListener('focus', function() { this.value = removeThousandsSeparator(this.value); });
    input.addEventListener('blur', function() { formatThousands(this); });
  });
  const revenusInput = document.getElementById("revenus_mensuels_caution");
  if (revenusInput) {
    revenusInput.addEventListener("input", function () {
      let value = this.value.replace(/[^\d]/g, "");
      if (value) { this.value = parseInt(value).toLocaleString("fr-FR") + " MGA"; } else { this.value = ""; }
    });
  }
  const financialFields = ['solde_mobile', 'solde_epargne', 'Caisse', 'echeances', 'encours_credit'];
  financialFields.forEach(id => {
    const field = document.getElementById(id);
    if (field) {
      field.addEventListener('input', function() {
        const displayElement = document.getElementById(this.id + '_display');
        if (displayElement) {
          let value = this.value.replace(/\D/g, '');
          const numValue = parseInt(value || 0);
          displayElement.textContent = numValue.toLocaleString('fr-FR') + ' MGA';
        }
      });
      field.addEventListener('focus', function() { this.value = this.value.replace(/\D/g, ''); });
    }
  });
  document.querySelectorAll('.df-input').forEach(input => {
    input.addEventListener('input', (e) => {
      let start = input.selectionStart;
      let end = input.selectionEnd;
      input.value = formatDF(input.value);
      input.setSelectionRange(start, end);
      updateTotalDF();
    });
  });
  document.querySelectorAll("input").forEach(inp=>{
    if(inp.type === "number" || inp.classList.contains('thousands-separator')){
      inp.addEventListener("input", calc);
    }
  });
  if (btnAjouter) {
    ajouterGarantie();
    btnAjouter.addEventListener('click', ajouterGarantie);
  }
  ['Caisse','solde_mobile','solde_epargne','creances_actuelles','creances_actuelles2','totalStock','total_actifs','dettes_fournisseurs','dettes_fournisseurs2','encours_credit','bilan_dettes_lt'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('input',majBilan);
  });
  document.querySelectorAll('#table_bilan .credit-avant-actif, #table_bilan .credit-avant-passif').forEach(inp=>inp.addEventListener('input',majBilan));
  
  const mensComEl = document.getElementById("mensualite_comite");
  if (mensComEl) {
    mensComEl.addEventListener("input", syncMensualite);
    mensComEl.addEventListener("change", syncMensualite);
  }
  
  const capEl = document.getElementById('capacite_paiement');
  if (capEl) capEl.addEventListener('input', controleMensualite);
  if (mensComEl) mensComEl.addEventListener('input', controleMensualite);
  
  applyPhoneFormat('num_client');
  applyPhoneFormat('num_caution');
  
  updateOpexTotal(); updateOpexTotal2(); updateTotalDepuisObjet();
  majCALigne1(); majCAMVSelonMarge(); majCAMVSelonMMP(); majCAMVMensuel();
  majCALigne2(); majCAMVSelonMarge2(); majCAMVMensuel2();
  calculerMMP(); updateTotalDF(); majBilan();
  
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      ['num_client', 'num_caution'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.value = input.value.replace(/\s+/g, '');
      });
    });
  }
}); 

document.addEventListener("input", calculerCashFlow);
document.addEventListener("input", majMensualites);

window.addEventListener('DOMContentLoaded', () => {
  const mensEl = document.getElementById('mensualite_comite');
  const capEl  = document.getElementById('capacite_paiement');

  if (mensEl) mensEl.addEventListener('input', controleMensualite);
  if (capEl)  capEl.addEventListener('input', controleMensualite);

  controleMensualite();
  
  const textarea = document.getElementById('pointsTextarea');
  if (textarea) autoResize(textarea);
});
</script>

</body>
</html>
